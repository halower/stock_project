# AI筛选403错误修复说明

## 问题现象
- AI技术分析功能正常
- AI智能筛选功能返回403错误："API认证失败(403)，请检查API Key"

## 问题原因

### 关键发现
AI筛选服务和AI分析服务的调用方式不同：
- **AI分析**：前端 → 后端API → AI服务（403正常处理）
- **AI筛选**：前端 → **直接调用** AI服务（403错误）

### 根本原因
在`ai_stock_filter_service.dart`中，调用阿里百炼API时错误地添加了：
```dart
headers['X-DashScope-Async'] = 'enable';
```

**问题分析：**
1. `X-DashScope-Async: enable` 是阿里百炼**异步调用模式**的header
2. 我们使用的是`compatible-mode`（兼容模式），这是**同步调用**
3. 在同步API中添加异步header会导致：
   - API认证失败
   - 返回HTTP 403错误
   - 提示"API认证失败，请检查API Key"

## 修复方案

### 修改的文件
`stock_app_client/lib/services/ai_stock_filter_service.dart`

### 修改内容
移除两处错误的异步header：

**第一处（单股筛选，约400行）：**
```dart
// ❌ 修复前
if (uri.host == 'dashscope.aliyuncs.com' && uri.path.startsWith('/compatible-mode/')) {
  headers['Authorization'] = 'Bearer $effectiveApiKey';
  headers['X-DashScope-Async'] = 'enable';  // ❌ 错误：同步调用不需要
}

// ✅ 修复后
if (uri.host == 'dashscope.aliyuncs.com' && uri.path.startsWith('/compatible-mode/')) {
  // 阿里百炼平台compatible-mode使用标准Bearer Token（同步调用）
  headers['Authorization'] = 'Bearer $effectiveApiKey';
  // 注意：X-DashScope-Async只用于异步调用，compatible-mode同步调用不需要
}
```

**第二处（汇总报告，约680行）：**
同样的修复逻辑。

## 阿里百炼API模式对比

### Compatible Mode（兼容模式）- 我们使用的
```
URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
调用方式: 同步（立即返回结果）
请求头:
  - Content-Type: application/json
  - Authorization: Bearer YOUR_API_KEY
  ✅ 不需要: X-DashScope-Async
```

### Async Mode（异步模式）- 我们不使用
```
URL: https://dashscope.aliyuncs.com/api/v1/services/...
调用方式: 异步（返回task_id，需要轮询结果）
请求头:
  - Content-Type: application/json
  - Authorization: Bearer YOUR_API_KEY
  - X-DashScope-Async: enable  ✅ 需要
```

## 为什么AI分析正常？

AI分析通过后端转发，后端代码(`stock_ai_analysis_service.py`)中**没有添加**`X-DashScope-Async` header，所以一直正常。

## 测试验证

修复后，AI智能筛选应该能正常工作：
1. 打开"技术面量化分析"页面
2. 点击"AI筛选"
3. 输入筛选条件，如"反弹概率大"
4. 点击"开始AI筛选"
5. 应该能正常筛选，不再出现403错误

## 经验总结

### ✅ 正确做法
- Compatible Mode（同步）：只需要`Authorization: Bearer TOKEN`
- 直接参考官方文档的兼容模式示例
- 保持与后端AI分析服务一致的请求头

### ❌ 常见错误
- 混用异步模式的header到同步API
- 参考了异步API的文档但用在兼容模式
- 添加不需要的额外header

---

**修复日期**：2025-10-18
**影响范围**：AI智能筛选功能
**修复方式**：移除错误的异步header

