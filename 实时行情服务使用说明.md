# 实时行情服务使用说明

## 🎯 核心功能

实现了一个**稳定可靠**的实时行情数据服务，支持**东方财富**和**新浪财经**两个数据源，并能自动切换，大大提高了系统的稳定性。

## ✨ 主要特性

### 1. 双数据源支持
- **东方财富**（东财）：`ak.stock_zh_a_spot_em()` 
- **新浪财经**：`ak.stock_zh_a_spot()`
- 一个失败自动切换到另一个，确保服务不中断

### 2. 智能切换
- 支持3种模式：
  - `eastmoney`: 优先使用东财，失败时切换新浪
  - `sina`: 优先使用新浪，失败时切换东财
  - `auto`: 自动根据历史成功率选择最优数据源 ⭐️**推荐**

### 3. 统一格式
无论使用哪个数据源，都返回统一的标准格式，上层代码无需修改

### 4. 实时监控
- 记录每个数据源的成功率
- 可随时查看统计信息
- 支持API接口动态查询和配置

## 🚀 快速开始

### 环境变量配置

在 `.env` 文件或环境变量中添加：

```bash
# 实时行情配置
REALTIME_DATA_PROVIDER=auto          # 推荐auto模式
REALTIME_UPDATE_INTERVAL=20          # 更新周期（分钟）
REALTIME_AUTO_SWITCH=true            # 启用自动切换
```

### Python代码使用

```python
from app.services.realtime_service import get_all_stocks_realtime, get_single_stock_realtime

# 获取所有股票实时行情
result = get_all_stocks_realtime()
if result['success']:
    print(f"获取 {result['count']} 只股票，数据源：{result['source']}")
    
# 获取单只股票
result = get_single_stock_realtime('600000')
if result['success']:
    data = result['data']
    print(f"{data['name']} 最新价：{data['price']}")
```

## 📡 API接口

### 1. 查看当前配置
```bash
GET http://localhost:8000/api/realtime/config
```

### 2. 修改配置
```bash
PUT http://localhost:8000/api/realtime/config
Content-Type: application/json

{
  "default_provider": "sina",
  "auto_switch": true
}
```

### 3. 查看统计信息
```bash
GET http://localhost:8000/api/realtime/stats
```

返回示例：
```json
{
  "total_requests": 100,
  "eastmoney": {
    "success": 95,
    "fail": 5,
    "success_rate": 95.0
  },
  "sina": {
    "success": 3,
    "fail": 2,
    "success_rate": 60.0
  },
  "last_provider": "eastmoney"
}
```

### 4. 测试数据源
```bash
# 测试东财
GET http://localhost:8000/api/realtime/test/eastmoney

# 测试新浪
GET http://localhost:8000/api/realtime/test/sina
```

### 5. 重置统计
```bash
POST http://localhost:8000/api/realtime/stats/reset
```

## 🧪 测试

运行测试脚本验证功能：

```bash
cd stock_app_service
python test_realtime_service.py
```

测试会验证：
- ✅ 东方财富数据源
- ✅ 新浪财经数据源
- ✅ 自动切换功能
- ✅ 单只股票查询
- ✅ 统计功能
- ✅ 数据格式一致性

## 📊 数据格式

所有数据源返回的标准格式：

```python
{
    'code': '600000',              # 股票代码
    'name': '浦发银行',             # 股票名称
    'price': 8.50,                 # 最新价
    'change': 0.15,                # 涨跌额
    'change_percent': 1.80,        # 涨跌幅(%)
    'volume': 15000000,            # 成交量（股）
    'amount': 127500000,           # 成交额（元）
    'high': 8.55,                  # 最高价
    'low': 8.45,                   # 最低价
    'open': 8.47,                  # 开盘价
    'pre_close': 8.35,             # 昨收价
    'buy': 8.49,                   # 买入价
    'sell': 8.51,                  # 卖出价
    'turnover_rate': 0.85,         # 换手率
    'timestamp': '14:30:00',       # 时间戳
    'update_time': '2025-10-21 14:30:15'  # 更新时间
}
```

## 🔄 系统集成

服务已自动集成到现有系统中：

### 1. 调度器（stock_scheduler.py）
`update_realtime_stock_data()` 函数每20分钟自动更新实时行情，使用新的服务

### 2. Redis服务（redis_stock_service.py）
`get_realtime_stock_data()` 函数使用新的统一服务获取数据

### 3. API路由（main.py）
自动注册了实时行情配置管理接口

## 💡 使用建议

### 生产环境
```bash
REALTIME_DATA_PROVIDER=auto          # 自动选择最优数据源
REALTIME_AUTO_SWITCH=true            # 必须开启自动切换
REALTIME_UPDATE_INTERVAL=20          # 20分钟更新一次
```

### 开发/测试环境
```bash
REALTIME_DATA_PROVIDER=eastmoney     # 可指定特定数据源测试
REALTIME_AUTO_SWITCH=true            # 建议开启
REALTIME_UPDATE_INTERVAL=5           # 可缩短周期用于测试
```

## ⚠️ 注意事项

1. **避免频繁调用**：建议最少间隔1分钟，否则可能被暂时封IP
2. **监控成功率**：定期查看统计信息，及时发现问题
3. **使用auto模式**：生产环境强烈推荐使用auto模式
4. **合理配置更新周期**：默认20分钟，不建议设置过短

## 📁 相关文件

### 核心代码
- `app/services/realtime_service.py` - 实时行情服务实现
- `app/api/realtime_config.py` - API接口
- `app/core/config.py` - 配置定义

### 文档
- `REALTIME_SERVICE_README.md` - 详细技术文档
- `REALTIME_SERVICE_SUMMARY.md` - 实现总结
- `test_realtime_service.py` - 测试脚本

## 🎉 优势总结

| 特性 | 说明 |
|------|------|
| 🔄 **高可用** | 双数据源自动切换，一个失败自动用另一个 |
| 📈 **智能选择** | auto模式根据历史成功率自动选最优数据源 |
| 📊 **实时监控** | 完整的统计信息，随时了解服务状态 |
| 🔧 **灵活配置** | 支持环境变量和API动态配置 |
| 🎯 **统一格式** | 标准化输出，无需关心底层数据源差异 |
| 🧪 **易于测试** | 提供完整测试脚本和API测试接口 |

## 🆘 问题排查

### 问题1：所有数据源都失败
**原因**：网络问题或IP被暂时封禁

**解决**：
1. 检查网络连接
2. 等待10-30分钟后重试
3. 减少调用频率

### 问题2：某个数据源成功率低
**诊断**：通过API查看统计信息
```bash
curl http://localhost:8000/api/realtime/stats
```

**解决**：
- 如果东财成功率低，设置 `REALTIME_DATA_PROVIDER=sina`
- 如果新浪成功率低，设置 `REALTIME_DATA_PROVIDER=eastmoney`
- 最简单的方法：使用 `auto` 模式让系统自动选择

### 问题3：数据更新不及时
**检查**：
1. 确认调度器是否正常运行
2. 查看 `REALTIME_UPDATE_INTERVAL` 配置
3. 检查日志中是否有错误信息

## 📞 技术支持

如有问题，请查看：
1. 详细文档：`stock_app_service/REALTIME_SERVICE_README.md`
2. 测试脚本：`stock_app_service/test_realtime_service.py`
3. 查看日志：`stock_app_service/logs/app.log`

---

**版本**: v1.0.0  
**更新日期**: 2025-10-21  
**开发者**: Stock Intelligence Team

