# ç¡…åŸºæµåŠ¨APIå‚æ•°ä¿®å¤ - å½»åº•å…³é—­æ€è€ƒè¿‡ç¨‹ ğŸ¯

**ä¿®å¤æ—¶é—´ï¼š** 2025-12-18  
**é—®é¢˜ï¼š** è®¾ç½®äº† `enable_thinking: false` ä½†AIä»ç„¶è¿”å›æ€è€ƒè¿‡ç¨‹

---

## ğŸ› é—®é¢˜æ ¹æº

### é”™è¯¯çš„å‚æ•°è®¾ç½® âŒ

**ä¹‹å‰çš„ä»£ç ï¼š**
```python
payload = {
    "model": model,
    "messages": messages,
    "max_tokens": max_tokens,
    "temperature": temperature,
    "enable_thinking": False,  # âŒ åªè®¾ç½®è¿™ä¸ªä¸å¤Ÿï¼
}
```

**é—®é¢˜ï¼š**
- åªè®¾ç½® `enable_thinking: false` **ä¸èƒ½å®Œå…¨å…³é—­æ€è€ƒ**
- æ ¹æ®ç¡…åŸºæµåŠ¨APIæ–‡æ¡£ï¼Œè¿˜éœ€è¦è®¾ç½® `thinking_budget: 0`

---

## ğŸ“š ç¡…åŸºæµåŠ¨APIæ–‡æ¡£è¯´æ˜

### å®˜æ–¹ç¤ºä¾‹

```bash
curl --request POST \
  https://api.siliconflow.cn/v1/chat/completions \
  --header 'Authorization: Bearer <token>' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "Qwen/QwQ-32B",
    "messages": [...],
    "max_tokens": 4096,
    "enable_thinking": false,      # â† ç¦ç”¨æ€è€ƒ
    "thinking_budget": 0,          # â† æ€è€ƒé¢„ç®—è®¾ä¸º0ï¼ˆå…³é”®ï¼ï¼‰
    "temperature": 0.7
  }'
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `enable_thinking` | boolean | æ˜¯å¦å¯ç”¨æ€è€ƒè¿‡ç¨‹ | true |
| `thinking_budget` | integer | æ€è€ƒè¿‡ç¨‹çš„tokené¢„ç®— | 4096 |

**å…³é”®ç‚¹ï¼š**
- `enable_thinking: false` - å‘Šè¯‰æ¨¡å‹ä¸è¦è¾“å‡ºæ€è€ƒ
- `thinking_budget: 0` - å°†æ€è€ƒçš„tokené¢„ç®—è®¾ä¸º0ï¼Œ**å½»åº•é˜»æ­¢æ€è€ƒè¾“å‡º**

**å¦‚æœåªè®¾ç½® `enable_thinking: false`ï¼Œä½† `thinking_budget` ä»ç„¶æ˜¯é»˜è®¤çš„4096ï¼Œæ¨¡å‹å¯èƒ½è¿˜ä¼šè¾“å‡ºæ€è€ƒå†…å®¹ï¼**

---

## âœ… æ­£ç¡®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–‡ä»¶ï¼š`stock_app_service/app/services/analysis/llm_service.py`

```python
# ä¿®å¤å‰ âŒ
payload = {
    "model": model,
    "messages": messages,
    "max_tokens": max_tokens,
    "temperature": temperature,
    "enable_thinking": False,  # åªæœ‰è¿™ä¸ª
}

# ä¿®å¤å âœ…
payload = {
    "model": model,
    "messages": messages,
    "max_tokens": max_tokens,
    "temperature": temperature,
    "enable_thinking": False,  # ç¦ç”¨æ€è€ƒè¿‡ç¨‹
    "thinking_budget": 0,      # æ€è€ƒé¢„ç®—è®¾ä¸º0ï¼Œå½»åº•å…³é—­
}
```

---

## ğŸ” ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Ÿ

### å‚æ•°ä½œç”¨æœºåˆ¶

```
enable_thinking: false
â”œâ”€ å‘Šè¯‰æ¨¡å‹ï¼š"è¯·ä¸è¦è¾“å‡ºæ€è€ƒè¿‡ç¨‹"
â””â”€ ä½†æ¨¡å‹å¯èƒ½ä»ç„¶ä¼šæ€è€ƒï¼ˆåªæ˜¯å°è¯•ä¸è¾“å‡ºï¼‰

thinking_budget: 0
â”œâ”€ å‘Šè¯‰æ¨¡å‹ï¼š"ä½ æ²¡æœ‰ä»»ä½•æ€è€ƒçš„tokené¢„ç®—"
â””â”€ ä»èµ„æºå±‚é¢å½»åº•é˜»æ­¢æ€è€ƒ
```

**ç±»æ¯”ï¼š**
- `enable_thinking: false` = å‘Šè¯‰å‘˜å·¥"ä¸è¦åŠ ç­"
- `thinking_budget: 0` = ç›´æ¥æ–­ç”µï¼Œç‰©ç†ä¸Šæ— æ³•åŠ ç­

**ä¸¤è€…ç»“åˆæ‰èƒ½å½»åº•å…³é—­ï¼** ğŸ’ª

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "enable_thinking": false
  // ç¼ºå°‘ thinking_budget: 0
}
```

**AIè¿”å›ï¼š**
```
ç°åœ¨ï¼Œæˆ‘éœ€è¦å°†è¿™äº›æ€è€ƒæ•´ç†æˆä¸€ä¸ªç»“æ„åŒ–çš„
åˆ†æï¼ŒåŒ…æ‹¬å¸‚åœºæƒ…ç»ªã€çƒ­ç‚¹è¡Œä¸šã€å®è§‚ç»æµã€
é£é™©å› ç´ ã€æŠ•èµ„ç­–ç•¥å’Œå…³é”®ä¿¡æ¯æ€»ç»“ã€‚</
think>

è´¢æ”¿æ–°é—»å…¨é¢åˆ†ææŠ¥å‘Š
...
```

**é—®é¢˜ï¼š** ä»ç„¶æœ‰æ€è€ƒè¿‡ç¨‹è¾“å‡º

---

### ä¿®å¤å âœ…

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "enable_thinking": false,
  "thinking_budget": 0  // âœ… å…³é”®å‚æ•°
}
```

**AIè¿”å›ï¼š**
```
è´¢æ”¿æ–°é—»å…¨é¢åˆ†ææŠ¥å‘Š

## 1. å¸‚åœºæ•´ä½“æƒ…ç»ªåˆ†æ

**å¸‚åœºæƒ…ç»ªï¼š** ç§¯æä¸­æ€§ååˆ†åŒ–

â€¢ **ç§‘æŠ€è¡Œä¸šï¼š** å°½ç®¡é¢ä¸´æ”¿ç­–æŒ‘æˆ˜...
â€¢ **é‡‘èè¡Œä¸šï¼š** é“¶è¡Œè‚¡è¡¨ç°å‡ºè‰²...

**æƒ…ç»ªæŒ‡æ•°ï¼š** 65åˆ†
...
```

**æ•ˆæœï¼š** å®Œå…¨æ²¡æœ‰æ€è€ƒè¿‡ç¨‹ï¼ ğŸ‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. é‡å¯æœåŠ¡ç«¯ï¼ˆå¿…é¡»ï¼ï¼‰

```bash
cd stock_app_service

# ä½¿ç”¨PM2é‡å¯
pm2 restart stock_service
pm2 logs stock_service

# æˆ–è€…ç›´æ¥é‡å¯
pkill -f "python.*stock_service"
python -m app.main
```

### 2. æ¸…é™¤ç¼“å­˜

```bash
# æ¸…é™¤Redisä¸­çš„æ–°é—»åˆ†æç¼“å­˜
redis-cli DEL "news:analysis:*"

# æˆ–è€…ç­‰å¾…2å°æ—¶ç¼“å­˜è‡ªåŠ¨è¿‡æœŸ
```

### 3. åœ¨APPä¸­æµ‹è¯•

1. æ‰“å¼€APP
2. è¿›å…¥"æ¶ˆæ¯é‡åŒ–"é¡µé¢
3. ç‚¹å‡»"æ¶ˆæ¯é¢AIè§£è¯»"æ ‡ç­¾
4. **ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®** â†»
5. ç­‰å¾…åŠ è½½å®Œæˆ
6. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ€è€ƒè¿‡ç¨‹

**é¢„æœŸç»“æœï¼š**
- âœ… å®Œå…¨æ²¡æœ‰ `<think>` æˆ– `</think>` æ ‡ç­¾
- âœ… æ²¡æœ‰"ç°åœ¨ï¼Œæˆ‘éœ€è¦å°†è¿™äº›æ€è€ƒ..."è¿™ç±»å†…å®¹
- âœ… ç›´æ¥æ˜¾ç¤ºåˆ†ææŠ¥å‘Š

---

## ğŸ¯ å…¶ä»–ä½¿ç”¨è¯¥LLMæœåŠ¡çš„åœ°æ–¹

è¿™ä¸ªä¿®å¤ä¼šå½±å“æ‰€æœ‰è°ƒç”¨ `llm_service.py` çš„åŠŸèƒ½ï¼š

### å·²ä¿®å¤çš„åŠŸèƒ½

1. âœ… **æ¶ˆæ¯é¢AIè§£è¯»** - `news_analysis_service.py`
2. âœ… **è‚¡ç¥¨AIåˆ†æ** - `stock_ai_analysis_service.py`
3. âœ… **AIç­›é€‰æœåŠ¡** - `enhanced_ai_filter_service.py`
4. âœ… **å…¶ä»–æ‰€æœ‰AIåˆ†æåŠŸèƒ½**

**æ‰€æœ‰åŠŸèƒ½éƒ½ä¼šå—ç›Šäºè¿™ä¸ªä¿®å¤ï¼** ğŸŒŸ

---

## ğŸ“Œ é‡è¦æç¤º

### 1. å¿…é¡»é‡å¯æœåŠ¡

Pythonä»£ç ä¿®æ”¹å**å¿…é¡»é‡å¯æœåŠ¡**æ‰èƒ½ç”Ÿæ•ˆï¼

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦é‡å¯æˆåŠŸ
pm2 status

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å‚æ•°ç”Ÿæ•ˆ
pm2 logs stock_service | grep "thinking_budget"
```

### 2. æ¸…é™¤ç¼“å­˜å¾ˆé‡è¦

å¦‚æœä¸æ¸…é™¤ç¼“å­˜ï¼Œå¯èƒ½ä¼šçœ‹åˆ°æ—§çš„åˆ†æç»“æœï¼ˆå¸¦æ€è€ƒè¿‡ç¨‹ï¼‰ã€‚

**ä¸¤ç§æ–¹å¼ï¼š**
- æ–¹å¼1ï¼šæ‰‹åŠ¨æ¸…é™¤Redisç¼“å­˜ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
- æ–¹å¼2ï¼šåœ¨APPä¸­ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰

### 3. å®¢æˆ·ç«¯æ¸…ç†ä»ç„¶ä¿ç•™

è™½ç„¶æœåŠ¡ç«¯å·²ç»å½»åº•å…³é—­æ€è€ƒï¼Œä½†**å®¢æˆ·ç«¯çš„æ¸…ç†é€»è¾‘ä»ç„¶ä¿ç•™**ï¼Œä½œä¸ºåŒé‡ä¿é™©ï¼š

```
é˜²å¾¡å±‚çº§ï¼š
ç¬¬1å±‚ï¼šæœåŠ¡ç«¯å‚æ•°ï¼ˆthinking_budget: 0ï¼‰â† ä¸»è¦é˜²çº¿
ç¬¬2å±‚ï¼šå®¢æˆ·ç«¯æ¸…ç†ï¼ˆ_cleanAnalysisContentï¼‰â† å¤‡ç”¨é˜²çº¿
```

å³ä½¿AIæ¨¡å‹æœ‰bugä»ç„¶è¾“å‡ºæ€è€ƒï¼Œå®¢æˆ·ç«¯ä¹Ÿä¼šæ¸…ç†æ‰ã€‚

---

## ğŸ”¬ æµ‹è¯•éªŒè¯

### æµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯•APIè°ƒç”¨ï¼ˆæ›¿æ¢<token>ä¸ºå®é™…tokenï¼‰
curl --request POST \
  https://api.siliconflow.cn/v1/chat/completions \
  --header 'Authorization: Bearer <token>' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "Qwen/QwQ-32B",
    "messages": [
      {
        "role": "user",
        "content": "åˆ†æä»Šæ—¥è‚¡å¸‚æƒ…å†µ"
      }
    ],
    "max_tokens": 2000,
    "enable_thinking": false,
    "thinking_budget": 0,
    "temperature": 0.7
  }'
```

**é¢„æœŸç»“æœï¼š**
- è¿”å›çš„å†…å®¹ä¸­**æ²¡æœ‰ä»»ä½•æ€è€ƒè¿‡ç¨‹**
- ç›´æ¥è¿”å›åˆ†æç»“è®º

---

## ğŸ“ APIå‚æ•°å®Œæ•´å¯¹ç…§è¡¨

| å‚æ•° | æˆ‘ä»¬çš„è®¾ç½® | è¯´æ˜ |
|------|-----------|------|
| `model` | åŠ¨æ€ä¼ å…¥ | AIæ¨¡å‹åç§° |
| `messages` | åŠ¨æ€ç”Ÿæˆ | å¯¹è¯æ¶ˆæ¯ |
| `max_tokens` | 3000-4000 | æœ€å¤§è¾“å‡ºtoken |
| `temperature` | 0.7 | éšæœºæ€§æ§åˆ¶ |
| `enable_thinking` | **false** âœ… | ç¦ç”¨æ€è€ƒ |
| `thinking_budget` | **0** âœ… | æ€è€ƒé¢„ç®—ä¸º0 |
| `stream` | false | éæµå¼è¾“å‡º |
| `top_p` | é»˜è®¤ | æ ¸é‡‡æ · |
| `frequency_penalty` | é»˜è®¤ | é¢‘ç‡æƒ©ç½š |

---

## âœ… ä¿®å¤æ¸…å•

- [x] æ·»åŠ  `thinking_budget: 0` å‚æ•°
- [x] ä¿ç•™ `enable_thinking: false` å‚æ•°
- [x] æ›´æ–°ä»£ç æ³¨é‡Š
- [x] åˆ›å»ºä¿®å¤æ–‡æ¡£
- [x] è¯´æ˜éƒ¨ç½²æ­¥éª¤

---

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

**ä¿®å¤å‰ï¼š**
```
</think>
ç°åœ¨ï¼Œæˆ‘éœ€è¦å°†è¿™äº›æ€è€ƒæ•´ç†...
```

**ä¿®å¤åï¼š**
```
è´¢æ”¿æ–°é—»å…¨é¢åˆ†ææŠ¥å‘Š

## 1. å¸‚åœºæ•´ä½“æƒ…ç»ªåˆ†æ
...
```

**å®Œå…¨æ²¡æœ‰æ€è€ƒè¿‡ç¨‹ï¼å½»åº•è§£å†³ï¼** ğŸ¯

---

**ä¿®å¤çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ  
**æµ‹è¯•å»ºè®®ï¼š** é‡å¯æœåŠ¡ â†’ æ¸…é™¤ç¼“å­˜ â†’ åˆ·æ–°APP  
**éƒ¨ç½²çŠ¶æ€ï¼š** âš ï¸ éœ€è¦é‡å¯åç«¯æœåŠ¡

**ç°åœ¨é‡å¯æœåŠ¡åï¼ŒAIå°†ä¸ä¼šå†è¾“å‡ºä»»ä½•æ€è€ƒè¿‡ç¨‹ï¼** ğŸš€

