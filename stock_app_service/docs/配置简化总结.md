# 配置简化总结

## 修改日期
2025-11-11

---

## 修改概述

简化实时行情配置，删除多余的配置项，只保留核心的Tushare实现。

---

## 修改内容

### 1. docker-compose.yml

**简化前**（5行）：
```yaml
# 实时数据更新配置
- REALTIME_UPDATE_ENABLED=true       # 是否启用实时数据更新
- REALTIME_DATA_PROVIDER=tushare     # 实时数据提供商（多选项）
- REALTIME_UPDATE_INTERVAL=1         # 实时更新周期
- REALTIME_AUTO_SWITCH=true          # 数据源自动切换
```

**简化后**（2行）：
```yaml
# 实时数据更新配置（仅Tushare）
- REALTIME_UPDATE_INTERVAL=1         # 实时更新周期（分钟）
```

**减少**：3个配置项（-60%）

---

### 2. app/core/config.py

**简化前**（22行）：
```python
# 实时行情配置（股票）
REALTIME_DATA_PROVIDER = ...
REALTIME_UPDATE_INTERVAL = ...
REALTIME_AUTO_SWITCH = ...
REALTIME_UPDATE_ENABLED = ...

# ETF实时行情配置
ETF_REALTIME_PROVIDER = ...
ETF_UPDATE_INTERVAL = ...
ETF_AUTO_SWITCH = ...
ETF_RETRY_TIMES = ...
ETF_MIN_REQUEST_INTERVAL = ...

# 动态代理IP配置
PROXY_ENABLED = ...
PROXY_API_URL = ...
PROXY_API_KEY = ...
PROXY_AUTH_PASSWORD = ...
PROXY_POOL_SIZE = ...
PROXY_REFRESH_INTERVAL = ...
PROXY_MAX_FAIL_COUNT = ...

# Settings类中
REALTIME_DATA_PROVIDER: str = ...
REALTIME_UPDATE_INTERVAL: int = ...
... (共19个字段)
```

**简化后**（2行）：
```python
# 实时行情配置（仅Tushare）
REALTIME_UPDATE_INTERVAL = int(os.getenv("REALTIME_UPDATE_INTERVAL", "1"))

# Settings类中
REALTIME_UPDATE_INTERVAL: int = REALTIME_UPDATE_INTERVAL
```

**减少**：20个配置项（-91%）

---

### 3. app/services/realtime/config.py

**简化前**（100行）：
```python
class DataProvider(Enum):
    TUSHARE = "tushare"
    EASTMONEY = "eastmoney"
    SINA = "sina"
    AUTO = "auto"

class RealtimeConfig(BaseModel):
    default_provider: DataProvider
    auto_switch: bool
    retry_times: int
    timeout: int
    enable_proxy: bool
    enable_realtime_update: bool

def _init_config_from_env():
    # 从环境变量读取多个配置
    ...

def update_config(...):
    # 更新多个配置项
    ...
```

**简化后**（35行）：
```python
class RealtimeConfig(BaseModel):
    retry_times: int = 3
    timeout: int = 10
    enable_realtime_update: bool = True

# 全局配置实例
realtime_config = RealtimeConfig()

def get_config() -> RealtimeConfig:
    return realtime_config
```

**减少**：65行代码（-65%）

---

### 4. app/services/realtime/__init__.py

**简化前**：
```python
from .config import DataProvider, RealtimeConfig, realtime_config, update_config, get_config

__all__ = [
    'DataProvider',
    'RealtimeConfig',
    'realtime_config',
    'update_config',
    'get_config',
    ...
]
```

**简化后**：
```python
from .config import RealtimeConfig, realtime_config, get_config

__all__ = [
    'RealtimeConfig',
    'realtime_config',
    'get_config',
    ...
]
```

**减少**：删除 `DataProvider` 和 `update_config`

---

## 删除的配置项

### 多数据源相关
- ❌ `REALTIME_DATA_PROVIDER` - 数据提供商选择
- ❌ `REALTIME_AUTO_SWITCH` - 自动切换数据源
- ❌ `REALTIME_UPDATE_ENABLED` - 是否启用实时更新

### ETF相关
- ❌ `ETF_REALTIME_PROVIDER` - ETF数据提供商
- ❌ `ETF_UPDATE_INTERVAL` - ETF更新周期
- ❌ `ETF_AUTO_SWITCH` - ETF自动切换
- ❌ `ETF_RETRY_TIMES` - ETF重试次数
- ❌ `ETF_MIN_REQUEST_INTERVAL` - ETF请求间隔

### 代理相关
- ❌ `PROXY_ENABLED` - 是否启用代理
- ❌ `PROXY_API_URL` - 代理API地址
- ❌ `PROXY_API_KEY` - 代理API密钥
- ❌ `PROXY_AUTH_PASSWORD` - 代理认证密码
- ❌ `PROXY_POOL_SIZE` - 代理池大小
- ❌ `PROXY_REFRESH_INTERVAL` - 代理刷新间隔
- ❌ `PROXY_MAX_FAIL_COUNT` - 代理最大失败次数

### 枚举和函数
- ❌ `DataProvider` 枚举
- ❌ `update_config()` 函数
- ❌ `_init_config_from_env()` 函数

---

## 保留的配置项

### 核心配置
- ✅ `REALTIME_UPDATE_INTERVAL` - 实时更新周期（分钟）

### RealtimeConfig类
- ✅ `retry_times` - 重试次数（默认3）
- ✅ `timeout` - 超时时间（默认10秒）
- ✅ `enable_realtime_update` - 启用实时更新（默认true）

---

## 统计对比

| 项目 | 简化前 | 简化后 | 减少 |
|------|--------|--------|------|
| **环境变量配置** | 5个 | 1个 | **-80%** |
| **config.py配置** | 20个 | 1个 | **-95%** |
| **RealtimeConfig字段** | 6个 | 3个 | **-50%** |
| **config.py代码行数** | 100行 | 35行 | **-65%** |
| **导出的类/函数** | 5个 | 3个 | **-40%** |

---

## 影响评估

### ✅ 无影响
- 核心功能完全保留
- Tushare数据源正常工作
- 实时更新正常执行
- 向后兼容（只是删除了未使用的配置）

### ⚠️ 需要注意
1. 如果之前手动配置了 `REALTIME_DATA_PROVIDER`，现在会被忽略
2. 如果使用了代理配置，需要删除相关环境变量
3. ETF相关的独立配置不再生效

### ✨ 改进
1. **配置更简单**：只需要配置一个更新间隔
2. **代码更清晰**：删除了大量unused代码
3. **维护更容易**：配置项少，出错概率低
4. **启动更快**：减少了配置加载和验证

---

## 使用说明

### 修改更新间隔

**docker-compose.yml**:
```yaml
environment:
  - REALTIME_UPDATE_INTERVAL=5  # 改为5分钟
```

### 代码中访问配置

```python
from app.core.config import settings

# 获取更新间隔
interval = settings.REALTIME_UPDATE_INTERVAL
print(f"更新间隔: {interval}分钟")
```

### RealtimeConfig配置

```python
from app.services.realtime import realtime_config

# 查看配置
print(f"重试次数: {realtime_config.retry_times}")
print(f"超时时间: {realtime_config.timeout}秒")
print(f"实时更新: {realtime_config.enable_realtime_update}")
```

---

## 迁移建议

### 如果使用了多数据源
**之前**:
```yaml
- REALTIME_DATA_PROVIDER=eastmoney
- REALTIME_AUTO_SWITCH=true
```

**现在**: 删除这些配置，系统只使用Tushare

### 如果配置了代理
**之前**:
```yaml
- PROXY_ENABLED=true
- PROXY_API_URL=...
```

**现在**: 删除这些配置，不再支持代理

### 如果配置了ETF独立更新
**之前**:
```yaml
- ETF_UPDATE_INTERVAL=30
- ETF_REALTIME_PROVIDER=eastmoney
```

**现在**: ETF和股票统一管理，使用相同的更新策略

---

## 总结

✅ **配置简化完成**  
✅ **代码行数减少65%**  
✅ **环境变量减少80%**  
✅ **核心功能不受影响**  
✅ **系统更简单、更稳定**

**唯一必需配置**: `REALTIME_UPDATE_INTERVAL`（默认1分钟）

