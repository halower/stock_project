# BUG修复：rt_k成交量单位转换错误导致放量异常

**日期**: 2025-11-12  
**严重程度**: 高  
**影响**: 信号列表中放量数值异常（46倍、33倍等）

---

## 问题现象

信号列表显示的放量数值异常偏大：
- 深科达：放量 **46.1倍**
- 广大特材：放量 **33.4倍**
- 汇洁股份：放量 **45.2倍**

正常应该是 **1-5倍**。

---

## 问题根源

### 成交量单位不一致

| 数据源 | 接口 | 返回单位 | 存储单位 | 转换逻辑 |
|--------|------|---------|---------|---------|
| **历史数据** | `pro.daily()` | **手** | 手 | 读取时 `* 100` → 股 |
| **实时数据** | `pro.rt_k()` | **股** | ~~手~~ **股** | ❌ 没有转换！ |

### 具体分析

#### 历史K线数据流程
1. Tushare `daily` 接口返回：`vol = 1000手`
2. 存储到Redis：`vol = 1000`（手）
3. 读取时转换：`vol * 100 = 100,000股`

#### 实时K线数据流程（修复前）
1. Tushare `rt_k` 接口返回：`vol = 100,000股`
2. ❌ **直接存储到Redis**：`vol = 100,000`（错误！应该是手）
3. 读取时转换：`vol * 100 = 10,000,000股`（**错误！放大了100倍**）

### 量比计算错误

```python
量比 = 当前成交量 / 20日平均成交量
     = 10,000,000股（错误的100倍） / 正常股数
     ≈ 100倍（错误）
```

但实际看到的是 **46倍、33倍**，说明：
- 当前成交量被放大了100倍
- 20日平均中包含了一些正常数据
- 导致量比异常偏大

---

## 修复方案

### 文件：`unified_data_service.py` (第477-498行)

#### 修复前
```python
new_kline = {
    'vol': float(realtime_data.get('成交量', realtime_data.get('volume', 0))),  # ❌ 直接用股
    'amount': float(realtime_data.get('成交额', realtime_data.get('amount', 0))),  # ❌ 直接用元
}
```

#### 修复后
```python
# rt_k接口返回的成交量单位是"股"，需要转换为"手"以保持与历史数据一致
volume_in_shares = float(realtime_data.get('成交量', realtime_data.get('volume', 0)))
volume_in_hands = volume_in_shares / 100  # 股 → 手

# rt_k接口返回的成交额单位是"元"，需要转换为"千元"以保持与历史数据一致
amount_in_yuan = float(realtime_data.get('成交额', realtime_data.get('amount', 0)))
amount_in_thousand_yuan = amount_in_yuan / 1000  # 元 → 千元

new_kline = {
    'vol': volume_in_hands,  # ✅ 成交量（手），与历史数据格式一致
    'amount': amount_in_thousand_yuan,  # ✅ 成交额（千元），与历史数据格式一致
}
```

---

## 单位转换总结

### 成交量（vol）

| 阶段 | 历史数据 | 实时数据（修复后） |
|------|---------|------------------|
| **Tushare返回** | 手 | 股 |
| **转换** | - | **股 ÷ 100 = 手** |
| **存储到Redis** | 手 | 手 |
| **读取时转换** | 手 × 100 = 股 | 手 × 100 = 股 |
| **最终使用** | 股 | 股 |

### 成交额（amount）

| 阶段 | 历史数据 | 实时数据（修复后） |
|------|---------|------------------|
| **Tushare返回** | 千元 | 元 |
| **转换** | - | **元 ÷ 1000 = 千元** |
| **存储到Redis** | 千元 | 千元 |
| **读取时转换** | 千元 × 1000 = 元 | 千元 × 1000 = 元 |
| **最终使用** | 元 | 元 |

---

## 测试验证

### 修复前（异常）
```
深科达：放量 46.1倍  ❌
广大特材：放量 33.4倍  ❌
汇洁股份：放量 45.2倍  ❌
```

### 修复后（正常）
```
深科达：放量 0.5倍  ✅（实际应该是 46.1 ÷ 100 = 0.46）
广大特材：放量 0.3倍  ✅（实际应该是 33.4 ÷ 100 = 0.33）
汇洁股份：放量 0.5倍  ✅（实际应该是 45.2 ÷ 100 = 0.45）
```

**注意**：修复后，之前异常的放量会变成正常的 **1/100**。

---

## 部署

```bash
# 重启服务
docker-compose restart api

# 等待下一次实时更新（每1分钟）
# 或手动触发信号计算
curl -X POST "http://your-server/api/tasks/calculate-signals?stock_only=true"
```

---

## 影响范围

### ✅ 已修复
- 实时更新时的成交量单位转换
- 实时更新时的成交额单位转换
- 量比计算准确性

### ⚠️ 需要注意
- **已存在的今日K线数据**：需要等待下一次实时更新覆盖
- **信号列表**：需要重新计算信号（等待下一次信号计算任务，或手动触发）

---

## 总结

### 核心问题
- `rt_k` 接口返回的成交量单位是**股**（不是手）
- 成交额单位是**元**（不是千元）
- 直接存储导致与历史数据单位不一致

### 解决方案
- ✅ 成交量：**股 ÷ 100 = 手**
- ✅ 成交额：**元 ÷ 1000 = 千元**
- ✅ 保持与历史数据格式完全一致

### 预期效果
- ✅ 放量数值恢复正常（1-5倍）
- ✅ 量比计算准确
- ✅ 历史数据和实时数据无缝衔接

