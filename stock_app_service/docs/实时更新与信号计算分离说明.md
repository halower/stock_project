# 实时更新与信号计算分离 - 说明文档

## 📋 概述

将**实时数据更新**和**策略信号计算**分离为两个独立的定时任务，实现更灵活的数据更新策略。

## 🎯 优化目标

1. ✅ **数据更新更频繁** - 每分钟更新一次股票数据
2. ✅ **信号随时可用** - 不需要等待信号计算完成
3. ✅ **降低计算压力** - 信号计算可以设置较长间隔（如5分钟）
4. ✅ **灵活配置** - 通过环境变量独立控制两个任务的频率

## 🔧 核心变更

### 1. 新增环境变量

**文件**: `docker-compose.yml` / `.env`

```yaml
# 实时数据更新配置
- REALTIME_UPDATE_INTERVAL=1         # 实时更新周期（分钟），默认1分钟
- SIGNAL_CALCULATION_INTERVAL=5      # 信号计算周期（分钟），默认5分钟
```

### 2. 调度器任务分离

**修改前**:
```
实时更新任务 (每20分钟)
  ↓
  更新数据
  ↓
  自动触发信号计算
```

**修改后**:
```
实时更新任务 (每1分钟)     信号计算任务 (每5分钟)
  ↓                           ↓
  更新数据                    计算信号
  ↓                           ↓
  完成                        完成
```

### 3. 代码变更

#### `app/core/config.py`
```python
# 新增配置
REALTIME_UPDATE_INTERVAL = int(os.getenv("REALTIME_UPDATE_INTERVAL", "1"))
SIGNAL_CALCULATION_INTERVAL = int(os.getenv("SIGNAL_CALCULATION_INTERVAL", "5"))
```

#### `app/services/scheduler/stock_scheduler.py`
```python
# 实时数据更新：每分钟执行一次
scheduler.add_job(
    func=RuntimeTasks.job_realtime_update,
    trigger=IntervalTrigger(minutes=settings.REALTIME_UPDATE_INTERVAL),
    id='realtime_update',
    name='实时数据更新',
    replace_existing=True
)

# 信号计算：独立定时任务
scheduler.add_job(
    func=RuntimeTasks.job_calculate_signals,
    trigger=IntervalTrigger(minutes=settings.SIGNAL_CALCULATION_INTERVAL),
    id='signal_calculation',
    name='策略信号计算',
    replace_existing=True
)
```

## 📊 任务时间表

### 交易日任务安排

| 时间 | 实时更新 | 信号计算 | 说明 |
|------|---------|---------|------|
| 9:30 | ✅ | ✅ | 开盘，同时更新和计算 |
| 9:31 | ✅ | ❌ | 仅更新数据 |
| 9:32 | ✅ | ❌ | 仅更新数据 |
| 9:33 | ✅ | ❌ | 仅更新数据 |
| 9:34 | ✅ | ❌ | 仅更新数据 |
| 9:35 | ✅ | ✅ | 同时更新和计算 |
| ... | 每1分钟 | 每5分钟 | 持续到收盘 |
| 15:00 | ✅ | ✅ | 收盘 |
| 15:30 | ❌ | ❌ | 盘后时间结束 |
| 17:35 | ✅ | ✅ | 全量更新+信号计算（包含ETF） |

### 每日执行次数

**交易时间**: 9:30 - 15:30（共6小时 = 360分钟）

- **实时更新**: 约 **360次/天** (每分钟1次)
- **信号计算**: 约 **72次/天** (每5分钟1次)

## 🎯 优势分析

### 1. 数据实时性提升

**修改前**:
- 更新间隔: 20分钟
- 数据延迟: 最多20分钟

**修改后**:
- 更新间隔: 1分钟
- 数据延迟: 最多1分钟
- **提升**: 数据实时性提升 **20倍**

### 2. 信号可用性提升

**修改前**:
- 获取信号时，可能正在计算中
- 需要等待计算完成（约3-5分钟）

**修改后**:
- 信号独立计算，不阻塞数据更新
- 随时可以获取最新信号
- 数据更新不影响信号查询

### 3. 系统负载优化

**修改前**:
- 每20分钟: 更新数据 + 计算信号
- 峰值负载高

**修改后**:
- 每1分钟: 仅更新数据（轻量）
- 每5分钟: 仅计算信号（重量）
- 负载分散，更平滑

## ⚙️ 配置建议

### 推荐配置（默认）

```yaml
REALTIME_UPDATE_INTERVAL=1         # 1分钟更新一次数据
SIGNAL_CALCULATION_INTERVAL=5      # 5分钟计算一次信号
```

**适用场景**: 
- 需要高频数据更新
- 信号不需要特别频繁计算
- 平衡性能和实时性

### 高频配置

```yaml
REALTIME_UPDATE_INTERVAL=1         # 1分钟更新
SIGNAL_CALCULATION_INTERVAL=2      # 2分钟计算
```

**适用场景**:
- 短线交易
- 需要快速响应市场变化
- 服务器性能充足

### 低频配置

```yaml
REALTIME_UPDATE_INTERVAL=5         # 5分钟更新
SIGNAL_CALCULATION_INTERVAL=10     # 10分钟计算
```

**适用场景**:
- 中长线交易
- 服务器资源有限
- 降低API调用频率

### 极致性能配置

```yaml
REALTIME_UPDATE_INTERVAL=1         # 1分钟更新
SIGNAL_CALCULATION_INTERVAL=1      # 1分钟计算
```

**注意**: 
- 计算压力大
- API调用频繁
- 需要强大服务器

## 📈 性能影响

### API调用频率

| 配置 | 更新频率 | 每日调用 | 说明 |
|------|---------|---------|------|
| 默认 (1分钟) | 360次/天 | ~180万次 | 5000只股票 × 360次 |
| 高频 (1分钟) | 360次/天 | ~180万次 | 同上 |
| 低频 (5分钟) | 72次/天 | ~36万次 | 5000只股票 × 72次 |

**注意**: Tushare限制 500次/分钟，当前配置完全在限制内。

### 计算资源

| 任务 | CPU | 内存 | 耗时 |
|------|-----|------|------|
| 实时更新 | ~20% | ~500MB | ~30秒 |
| 信号计算 | ~40% | ~800MB | ~3分钟 |

## 🚀 使用方法

### 1. 修改配置

编辑 `docker-compose.yml`:

```yaml
environment:
  - REALTIME_UPDATE_INTERVAL=1         # 修改为你需要的间隔
  - SIGNAL_CALCULATION_INTERVAL=5      # 修改为你需要的间隔
```

### 2. 重启服务

```bash
docker-compose restart api
```

### 3. 查看日志

```bash
docker logs -f stock_app_api | grep "定时任务"
```

你会看到：
```
定时任务:
  - 实时数据更新: 每1分钟（交易时间）
  - 策略信号计算: 每5分钟（交易时间，独立任务）
```

### 4. 监控任务执行

查看实时更新:
```bash
docker logs -f stock_app_api | grep "实时数据更新"
```

查看信号计算:
```bash
docker logs -f stock_app_api | grep "信号计算"
```

## 📌 注意事项

### 1. 交易时间限制

两个任务都只在交易时间执行（9:30-15:30），非交易时间自动跳过。

### 2. 全量更新不受影响

每日17:35的全量更新仍然包含：
- 股票 + ETF数据更新
- 股票 + ETF信号计算

### 3. 任务互不干扰

- 实时更新和信号计算有独立的锁
- 一个任务执行不会阻塞另一个
- 如果任务正在执行，新的触发会被跳过

### 4. API限流保护

系统内置频率限制器，确保不会超过Tushare的500次/分钟限制。

## 🔍 故障排查

### 问题1: 数据更新频率不对

**检查**:
```bash
docker logs stock_app_api | grep "REALTIME_UPDATE_INTERVAL"
```

**解决**: 确认环境变量设置正确

### 问题2: 信号计算没有执行

**检查**:
```bash
docker logs stock_app_api | grep "信号计算"
```

**可能原因**:
- 非交易时间
- 任务正在执行中
- 系统错误

### 问题3: API限流

**现象**: 日志中出现"触发Tushare频率限制"

**解决**: 
- 增加 `REALTIME_UPDATE_INTERVAL` 的值
- 系统会自动等待并重试

## 📖 相关文档

- [ETF盘中更新优化说明](./ETF盘中更新优化说明.md)
- [全量更新优化说明](./全量更新优化说明.md)
- [实时数据更新优化说明](./实时数据更新优化说明.md)

## ✅ 总结

通过将实时更新和信号计算分离：

1. ✅ **数据更新更快** - 从20分钟缩短到1分钟
2. ✅ **信号随时可用** - 不需要等待计算
3. ✅ **系统更稳定** - 负载分散，不会峰值过高
4. ✅ **配置更灵活** - 可以根据需求独立调整

---

**更新日期**: 2025-11-11
**版本**: v2.0

