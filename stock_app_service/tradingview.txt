//@version=5
indicator("K线镜像翻转", overlay=false)

// 使用第一根K线的收盘价作为起点
var float startPrice = close
var float invertedPrice = startPrice

// 计算当前K线相对于前一根的涨跌幅
pctChange = (close - close[1]) / close[1]

// 翻转后的价格变化：涨跌幅取反
if bar_index > 0
    invertedPrice := invertedPrice * (1 - pctChange)

// 计算翻转后的OHLC
// 每根K线内部的涨跌也要反转
openPct = (open - close[1]) / close[1]
highPct = (high - close[1]) / close[1]
lowPct = (low - close[1]) / close[1]

invertedOpen = bar_index > 0 ? invertedPrice[1] * (1 - openPct) : startPrice
invertedHigh = bar_index > 0 ? invertedPrice[1] * (1 - lowPct) : high  // 高低互换
invertedLow = bar_index > 0 ? invertedPrice[1] * (1 - highPct) : low   // 高低互换
invertedClose = invertedPrice

// 绘制翻转后的K线（始终显示）
isInvertedUp = invertedClose > invertedOpen
plotcandle(invertedOpen, invertedHigh, invertedLow, invertedClose, title="翻转K线", 
           color=isInvertedUp ? color.red : color.green, 
           wickcolor=isInvertedUp ? color.red : color.green, 
           bordercolor=isInvertedUp ? color.red : color.green)