# 系统任务计划清单

> 最后更新时间：2025-11-08

## 📋 定时任务总览

系统使用 **APScheduler** 作为任务调度器，共有3个独立的调度器模块。

---

## 1️⃣ 股票数据调度器 (Stock Scheduler)

**文件位置**: `app/services/scheduler/stock_scheduler.py`

### 定时任务列表

| 任务名称 | 执行时间 | 说明 | 函数名 |
|---------|---------|------|--------|
| 股票代码检查 | 每周一 08:00 + 启动时立即执行 | 检查并更新股票代码列表 | `check_and_update_stock_codes()` |
| K线数据全量更新 | 每个工作日 17:30 | 清空并重新获取所有股票的历史K线数据 | `clear_and_refetch_all_klines()` |
| 实时数据更新 | 交易时间内每15分钟 | 更新股票实时价格并合并到K线数据 | `update_realtime_data_job()` |
| 收盘数据更新 | 每个交易日 15:20 | 收盘后获取最终价格数据 | `update_closing_data_job()` |
| 策略信号计算（盘中） | 交易时间内每30分钟 | 计算买入信号（盘中快速计算） | `calculate_signals_job()` |
| 策略信号计算（收盘后） | 每个交易日 17:35 | 收盘后完整计算所有策略信号 | `calculate_signals_after_closing()` |

### 交易时间判断

- **交易时间**: 周一至周五 9:30-11:30, 13:00-15:00
- **收盘后时间**: 15:00-15:30（可获取收盘数据）
- **周末和节假日**: 不执行交易相关任务

### 初始化模式

系统支持多种初始化模式（通过环境变量 `STOCK_INIT_MODE` 或API接口设置）：

| 模式 | 说明 | 执行内容 |
|------|------|---------|
| `skip` | 跳过初始化 | 不执行任何初始化操作 |
| `tasks_only` | 仅执行任务 | 不获取历史数据，只执行信号计算等任务 |
| `full_init` | 完整初始化 | 清空所有数据（股票+ETF）重新获取 |
| `etf_only` | 仅初始化ETF | 只获取和更新ETF数据 |

### Redis数据键

```python
STOCK_KEYS = {
    'stock_codes': 'stocks:codes:all',           # 股票代码列表
    'stock_kline': 'stock_trend:{}',             # K线数据（需填充ts_code）
    'strategy_signals': 'stock:buy_signals',     # 策略信号
    'realtime_data': 'stock:realtime',           # 实时数据
    'scheduler_log': 'stock:scheduler:log',      # 调度器日志
    'last_update': 'stock:last_update',          # 最后更新时间
}

ETF_KEYS = {
    'etf_codes': 'etf:codes:all',                # ETF代码列表
    'etf_kline': 'etf_trend:{}',                 # ETF K线数据
    'etf_signals': 'etf:buy_signals',            # ETF策略信号
    'etf_realtime': 'etf:realtime',              # ETF实时数据
    'etf_scheduler_log': 'etf:scheduler:log',    # ETF调度器日志
    'etf_last_update': 'etf:last_update',        # ETF最后更新时间
}
```

---

## 2️⃣ 新闻调度器 (News Scheduler)

**文件位置**: `app/services/scheduler/news_scheduler.py`

### 定时任务列表

| 任务名称 | 执行时间 | 说明 | 函数名 |
|---------|---------|------|--------|
| 新闻爬取 | 每2小时 + 启动时立即执行 | 爬取凤凰财经新闻并缓存 | `crawl_and_cache_news()` |

### 新闻数据来源

- **数据源**: 凤凰财经 (Phoenix Finance)
- **爬取范围**: 最近1天的财经新闻
- **数据质量检查**: 至少5条新闻才更新缓存
- **缓存时效**: 2小时（自动刷新）

### Redis数据键

```python
NEWS_KEYS = {
    'news_latest': 'news:latest',                # 最新新闻列表
    'news_scheduler_log': 'news:scheduler:log',  # 调度器日志
    'news_last_update': 'news:last_update',      # 最后更新时间
}
```

---

## 3️⃣ 图表清理调度器 (Chart Cleanup Scheduler)

**文件位置**: `app/tasks/scheduler.py`

### 定时任务列表

| 任务名称 | 执行时间 | 说明 | 函数名 |
|---------|---------|------|--------|
| 图表文件清理 | 每天 00:00 | 清理所有生成的图表HTML文件 | `cleanup_chart_files()` |

### 清理策略

- **清理目标**: `static/charts/` 目录下的所有 `.html` 文件
- **清理时间**: 每天凌晨0点
- **备选方案**: 也可清理指定天数之前的文件（`cleanup_old_chart_files()`）

---

## 🔧 任务管理接口

### 股票调度器管理

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/stocks/scheduler/status` | GET | 获取股票调度器状态 |
| `/api/stocks/scheduler/init` | POST | 初始化股票/ETF系统 |
| `/api/stocks/scheduler/trigger` | POST | 手动触发股票任务 |
| `/api/scheduler/restart` | POST | 重启所有调度器 |

### 新闻调度器管理

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/news/scheduler/status` | GET | 获取新闻调度器状态 |
| `/api/news/scheduler/trigger` | POST | 立即触发新闻爬取 |

---

## 📊 任务执行日志

所有调度器都会记录任务执行日志：

- **内存日志**: 最近10条（快速查看）
- **Redis日志**: 最近20条（持久化，TTL=24小时）
- **日志内容**: 时间戳、任务类型、状态、消息、数据量、执行时间

### 日志查询方式

1. **通过API接口**: 调用状态接口查看最近执行日志
2. **通过Redis**: 直接查询对应的日志键
3. **通过系统日志**: 查看 `logs/app.log` 文件

---

## ⚙️ 配置参数

### 环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `STOCK_INIT_MODE` | `tasks_only` | 股票系统初始化模式 |
| `REALTIME_UPDATE_INTERVAL` | `15` | 实时数据更新间隔（分钟） |
| `SIGNAL_CALC_INTERVAL` | `30` | 信号计算间隔（分钟） |
| `NEWS_CRAWL_INTERVAL` | `120` | 新闻爬取间隔（分钟） |

### 代码配置

可在各调度器文件中修改：

```python
# 股票调度器 (stock_scheduler.py)
- K线数据获取天数: 180天
- 信号计算批次大小: 500只股票/批
- 并发数量: 100

# 新闻调度器 (news_scheduler.py)
- 新闻爬取天数: 1天
- 最小新闻数量: 5条
- 缓存TTL: 2小时

# 图表清理调度器 (scheduler.py)
- 清理时间: 每天00:00
- 清理目标: 所有HTML文件
```

---

## 🚀 启动流程

### 1. 系统启动时

```
1. 启动图表清理调度器 (scheduler.start())
2. 启动新闻调度器 (start_news_scheduler())
   - 立即执行一次新闻爬取
3. 启动股票调度器 (start_stock_scheduler())
   - 根据初始化模式执行相应操作
   - 立即执行一次股票代码检查
```

### 2. 运行期间

```
- 股票调度器: 按时间表自动执行各项任务
- 新闻调度器: 每2小时自动爬取新闻
- 图表清理: 每天凌晨清理图表文件
```

### 3. 关闭时

```
1. 停止所有调度器
2. 等待正在执行的任务完成
3. 关闭Redis连接
```

---

## 📝 维护建议

### 日常维护

1. **监控调度器状态**: 定期调用状态接口检查
2. **查看执行日志**: 确认任务正常执行
3. **检查数据质量**: 验证股票数据和新闻数据
4. **清理过期数据**: Redis会自动清理TTL过期的数据

### 故障排查

1. **任务未执行**: 检查调度器是否运行
2. **数据未更新**: 查看执行日志中的错误信息
3. **性能问题**: 调整批次大小和并发数量
4. **Redis连接问题**: 检查Redis服务状态

### 性能优化

1. **调整执行时间**: 避开高峰期执行重任务
2. **优化批处理**: 根据服务器性能调整批次大小
3. **缓存策略**: 合理设置TTL，减少重复计算
4. **并发控制**: 避免过多并发导致资源耗尽

---

## 🔄 任务依赖关系

```
股票代码检查 (每周一)
    ↓
K线数据全量更新 (每天17:30)
    ↓
策略信号计算 (17:35)
    ↓
实时数据更新 (交易时间内)
    ↓
信号重新计算 (交易时间内)
```

**注意**: 
- K线数据更新后才能计算信号
- 实时数据会自动合并到K线数据
- 收盘后会进行完整的信号计算

---

## ⚠️ 重要提示

1. **不要在交易时间手动触发全量数据更新**，会影响实时数据
2. **初始化模式选择要谨慎**，`full_init` 会清空所有数据
3. **定期检查Redis存储空间**，避免数据过多导致内存不足
4. **备份重要配置**，如ETF列表、策略参数等
5. **监控任务执行时间**，如果某个任务执行时间过长，需要优化

---

## 📞 相关文档

- [HTTP_API_清单.md](./HTTP_API_清单.md) - 接口文档
- [本文件不能删除.md](./本文件不能删除.md) - 系统初始化说明

