# ç³»ç»Ÿä»»åŠ¡è®¡åˆ’æ¸…å•

> æœ€åæ›´æ–°æ—¶é—´ï¼š2025-11-08
> æŒ‰ç…§DDDåŸåˆ™é‡æ„ï¼Œç»Ÿä¸€è‚¡ç¥¨å’ŒETFæ•°æ®å¤„ç†

## ğŸ“‹ é‡æ„è¯´æ˜

æœ¬æ¬¡é‡æ„æŒ‰ç…§DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰åŸåˆ™ï¼Œå°†ä»»åŠ¡ç³»ç»Ÿé‡æ–°ç»„ç»‡ä¸ºï¼š

1. **ç»Ÿä¸€æ•°æ®æœåŠ¡** - å°è£…è‚¡ç¥¨å’ŒETFçš„å†å²æ•°æ®å’Œå®æ—¶æ•°æ®è·å–
2. **åŸå­èƒ½åŠ›æ–¹æ³•** - ç‹¬ç«‹çš„ä¸šåŠ¡èƒ½åŠ›å•å…ƒ
3. **å¯åŠ¨ä»»åŠ¡** - ç³»ç»Ÿé¦–æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œ
4. **è¿è¡Œæ—¶ä»»åŠ¡** - å¯åŠ¨åå®šæ—¶æ‰§è¡Œ

---

## ğŸ”§ ç»Ÿä¸€æ•°æ®æœåŠ¡

**æ–‡ä»¶ä½ç½®**: `app/services/stock/unified_data_service.py`

### æ ¸å¿ƒåŠŸèƒ½

| æ–¹æ³•å | è¯´æ˜ |
|--------|------|
| `fetch_historical_data(ts_code, days, is_etf)` | ç»Ÿä¸€çš„å†å²æ•°æ®è·å–ï¼ˆè‚¡ç¥¨+ETFï¼‰ |
| `async_fetch_historical_data(...)` | å¼‚æ­¥ç‰ˆæœ¬çš„å†å²æ•°æ®è·å– |
| `fetch_stock_realtime_data()` | è·å–æ‰€æœ‰è‚¡ç¥¨çš„å®æ—¶æ•°æ®ï¼ˆæ–°æµªæ¥å£ï¼‰ |
| `fetch_etf_realtime_data()` | è·å–æ‰€æœ‰ETFçš„å®æ—¶æ•°æ®ï¼ˆæ–°æµªæ¥å£ï¼‰ |
| `fetch_all_realtime_data()` | è·å–æ‰€æœ‰è‚¡ç¥¨å’ŒETFçš„å®æ—¶æ•°æ® |
| `async_fetch_all_realtime_data()` | å¼‚æ­¥ç‰ˆæœ¬ |
| `update_kline_with_realtime(...)` | ç”¨å®æ—¶æ•°æ®æ›´æ–°å†å²Kçº¿ï¼ˆå½“æ—¥æœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ–°å¢ï¼‰ |
| `batch_update_klines_with_realtime(...)` | æ‰¹é‡æ›´æ–°Kçº¿æ•°æ® |
| `async_batch_update_klines_with_realtime(...)` | å¼‚æ­¥ç‰ˆæœ¬ |

### Rediså­˜å‚¨é”®è§„åˆ™

**ç»Ÿä¸€è§„åˆ™**ï¼šè‚¡ç¥¨å’ŒETFä½¿ç”¨ç›¸åŒçš„é”®æ ¼å¼

```python
# Kçº¿æ•°æ®
'stock_trend:{ts_code}'  # ä¾‹å¦‚: stock_trend:000001.SZ, stock_trend:510050.SH

# è‚¡ç¥¨ä»£ç åˆ—è¡¨
'stocks:codes:all'

# ç­–ç•¥ä¿¡å·
'stock:buy_signals'
```

**ä¼˜åŠ¿**ï¼š
- ETFä½œä¸ºç‰¹æ®Šè‚¡ç¥¨ç»Ÿä¸€ç®¡ç†
- ä»£ç å”¯ä¸€æ€§ä¿è¯ä¸ä¼šå†²çª
- ç®€åŒ–æ•°æ®å¤„ç†é€»è¾‘

---

## âš™ï¸ åŸå­èƒ½åŠ›æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `app/services/stock/stock_atomic_service.py`

| æ–¹æ³•å | è¯´æ˜ |
|--------|------|
| `get_all_valid_stock_codes()` | è·å–æ‰€æœ‰æœ‰æ•ˆè‚¡ç¥¨å’ŒETFä»£ç åˆ—è¡¨ï¼Œè‡ªåŠ¨è¿‡æ»¤æ— æ•ˆä»£ç ã€‚ |
| `full_update_all_stocks()` | æ¸…ç©ºæ‰€æœ‰è‚¡ç¥¨å’ŒETFçš„Kçº¿æ•°æ®ï¼Œå¹¶é‡æ–°è·å–90ä¸ªäº¤æ˜“æ—¥çš„å†å²æ•°æ®ã€‚ |
| `realtime_update_all_stocks()` | **å®æ—¶æ›´æ–°æ‰€æœ‰è‚¡ç¥¨å’ŒETFçš„æœ€æ–°ä»·æ ¼ï¼Œå¹¶åˆå¹¶åˆ°Kçº¿æ•°æ®ä¸­ã€‚** |
| `calculate_all_signals()` | è®¡ç®—æ‰€æœ‰è‚¡ç¥¨å’ŒETFçš„ä¹°å…¥ä¿¡å·ã€‚ |
| `crawl_latest_news()` | çˆ¬å–æœ€æ–°çš„è´¢ç»æ–°é—»å¹¶ç¼“å­˜ã€‚ |
| `cleanup_chart_files()` | æ¸…ç†é™æ€å›¾è¡¨æ–‡ä»¶ã€‚ |

### å®æ—¶æ›´æ–°æ–¹æ³•è¯¦è§£

`realtime_update_all_stocks()` æ–¹æ³•çš„å·¥ä½œæµç¨‹ï¼š

1. **è·å–å®æ—¶æ•°æ®**ï¼šè°ƒç”¨ `unified_data_service.async_fetch_all_realtime_data()`
   - è·å–æ‰€æœ‰è‚¡ç¥¨çš„å®æ—¶æ•°æ®ï¼ˆæ–°æµªæ¥å£ï¼‰
   - è·å–æ‰€æœ‰ETFçš„å®æ—¶æ•°æ®ï¼ˆæ–°æµªæ¥å£ï¼‰

2. **æ‰¹é‡æ›´æ–°Kçº¿**ï¼šè°ƒç”¨ `unified_data_service.async_batch_update_klines_with_realtime()`
   - éå†æ¯åªè‚¡ç¥¨/ETFçš„å®æ—¶æ•°æ®
   - æ£€æŸ¥Redisä¸­æ˜¯å¦æœ‰å†å²Kçº¿æ•°æ®
   - å¦‚æœä»Šæ—¥å·²æœ‰Kçº¿æ•°æ®ï¼Œåˆ™æ›´æ–°
   - å¦‚æœä»Šæ—¥æ²¡æœ‰Kçº¿æ•°æ®ï¼Œåˆ™æ–°å¢
   - ä¿æŒæœ€è¿‘180å¤©çš„æ•°æ®

3. **è¿”å›ç»“æœç»Ÿè®¡**ï¼š
   - æˆåŠŸæ›´æ–°æ•°é‡
   - å¤±è´¥æ•°é‡
   - è€—æ—¶ç»Ÿè®¡

---

## ğŸš€ å¯åŠ¨ä»»åŠ¡

**æ–‡ä»¶ä½ç½®**: `app/services/scheduler/stock_scheduler.py` - `start_stock_scheduler` å‡½æ•°

### å¯åŠ¨æµç¨‹

```
1. è·å–æœ‰æ•ˆè‚¡ç¥¨ä»£ç åˆ—è¡¨ï¼ˆå¿…é¡»ï¼‰
2. æ ¹æ®åˆå§‹åŒ–æ¨¡å¼æ‰§è¡ŒKçº¿æ•°æ®åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰
3. å¯åŠ¨æ—¶çˆ¬å–æœ€æ–°æ–°é—»ï¼ˆå¿…é¡»ï¼‰
4. å¯åŠ¨æ—¶è®¡ç®—ä¹°å…¥ä¿¡å·ï¼ˆå¯é€‰ï¼‰
```

### åˆå§‹åŒ–æ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | æ‰§è¡Œå†…å®¹ |
|------|------|---------|
| `skip` | è·³è¿‡åˆå§‹åŒ– | åªè·å–è‚¡ç¥¨ä»£ç å’Œçˆ¬å–æ–°é—» |
| `full_init` | å…¨é‡åˆå§‹åŒ– | è·å–è‚¡ç¥¨ä»£ç  + å…¨é‡æ›´æ–°Kçº¿æ•°æ® + çˆ¬å–æ–°é—» |

### å¯åŠ¨å‚æ•°

```python
start_stock_scheduler(
    init_mode="skip",           # åˆå§‹åŒ–æ¨¡å¼
    calculate_signals=False     # æ˜¯å¦è®¡ç®—ä¿¡å·
)
```

**ä½¿ç”¨åœºæ™¯**:

1. **é¦–æ¬¡éƒ¨ç½²**:
   ```python
   start_stock_scheduler(init_mode="full_init", calculate_signals=True)
   ```

2. **æ—¥å¸¸é‡å¯**:
   ```python
   start_stock_scheduler(init_mode="skip", calculate_signals=False)
   ```

3. **æ•°æ®ä¿®å¤**:
   ```python
   start_stock_scheduler(init_mode="full_init", calculate_signals=True)
   ```

---

## â° è¿è¡Œæ—¶ä»»åŠ¡

**æ–‡ä»¶ä½ç½®**: `app/services/scheduler/stock_scheduler.py` - `BackgroundScheduler` é…ç½®

### å®šæ—¶ä»»åŠ¡åˆ—è¡¨

| ä»»åŠ¡åç§° | æ‰§è¡Œæ—¶é—´ | è¯´æ˜ | æ–¹æ³•å |
|---------|---------|------|--------|
| å®æ—¶æ•°æ®æ›´æ–° | æ¯20åˆ†é’Ÿï¼ˆäº¤æ˜“æ—¶é—´+ç›˜å30åˆ†é’Ÿï¼‰ | è·å–æ‰€æœ‰è‚¡ç¥¨å’ŒETFçš„æœ€æ–°ä»·æ ¼ï¼Œå¹¶åˆå¹¶åˆ°Kçº¿æ•°æ®ä¸­ã€‚ | `realtime_update_all_stocks` |
| æ–°é—»çˆ¬å– | æ¯2å°æ—¶ | çˆ¬å–æœ€æ–°çš„è´¢ç»æ–°é—»å¹¶ç¼“å­˜ã€‚ | `crawl_latest_news` |
| å…¨é‡æ›´æ–°å¹¶è®¡ç®—ä¿¡å· | æ¯ä¸ªäº¤æ˜“æ—¥17:35 | æ¸…ç©ºæ‰€æœ‰Kçº¿æ•°æ®ï¼Œé‡æ–°è·å–å†å²æ•°æ®ï¼Œå¹¶è®¡ç®—æ‰€æœ‰ä¹°å…¥ä¿¡å·ã€‚ | `full_update_all_stocks` + `calculate_all_signals` |
| å›¾è¡¨æ–‡ä»¶æ¸…ç† | æ¯å¤©00:00 | æ¸…ç†é™æ€å›¾è¡¨ç›®å½•ä¸­çš„æ—§HTMLæ–‡ä»¶ã€‚ | `cleanup_chart_files` |

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. å¯åŠ¨è°ƒåº¦å™¨

```python
from app.services.scheduler.stock_scheduler import start_stock_scheduler

# é¦–æ¬¡éƒ¨ç½²
start_stock_scheduler(init_mode="full_init", calculate_signals=True)

# æ—¥å¸¸é‡å¯
start_stock_scheduler(init_mode="skip", calculate_signals=False)
```

### 2. åœæ­¢è°ƒåº¦å™¨

```python
from app.services.scheduler.stock_scheduler import stop_stock_scheduler

stop_stock_scheduler()
```

### 3. æŸ¥çœ‹çŠ¶æ€

```python
from app.services.scheduler.stock_scheduler import get_stock_scheduler_status

status = get_stock_scheduler_status()
print(f"è¿è¡ŒçŠ¶æ€: {status['running']}")
print(f"å®šæ—¶ä»»åŠ¡: {status['jobs']}")
print(f"æœ€è¿‘æ—¥å¿—: {status['recent_logs']}")
```

### 4. æ‰‹åŠ¨è°ƒç”¨åŸå­æ–¹æ³•

```python
from app.services.stock.stock_atomic_service import stock_atomic_service

# è·å–æ‰€æœ‰æœ‰æ•ˆè‚¡ç¥¨ä»£ç 
all_stocks = await stock_atomic_service.get_all_valid_stock_codes()

# å…¨é‡æ›´æ–°æ‰€æœ‰è‚¡ç¥¨æ•°æ®
await stock_atomic_service.full_update_all_stocks()

# å®æ—¶æ›´æ–°æ‰€æœ‰è‚¡ç¥¨æ•°æ®
result = await stock_atomic_service.realtime_update_all_stocks()
print(f"æˆåŠŸæ›´æ–°: {result['total_updated']}, å¤±è´¥: {result['total_failed']}")

# è®¡ç®—æ‰€æœ‰ä¿¡å·
await stock_atomic_service.calculate_all_signals(force_recalculate=True)
```

### 5. ä½¿ç”¨ç»Ÿä¸€æ•°æ®æœåŠ¡

```python
from app.services.stock.unified_data_service import unified_data_service

# è·å–å•åªè‚¡ç¥¨çš„å†å²æ•°æ®
kline_data = unified_data_service.fetch_historical_data(
    ts_code="000001.SZ",
    days=90,
    is_etf=False
)

# è·å–å•åªETFçš„å†å²æ•°æ®
etf_data = unified_data_service.fetch_historical_data(
    ts_code="510050.SH",
    days=90,
    is_etf=True
)

# è·å–æ‰€æœ‰è‚¡ç¥¨å’ŒETFçš„å®æ—¶æ•°æ®
realtime_result = unified_data_service.fetch_all_realtime_data()
print(f"è‚¡ç¥¨: {realtime_result['stock_count']}, ETF: {realtime_result['etf_count']}")
```

---

## ğŸ’¡ ç»´æŠ¤å»ºè®®

1. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥è°ƒåº¦å™¨æ—¥å¿—ï¼Œç¡®ä¿ä»»åŠ¡æ­£å¸¸æ‰§è¡Œã€‚
2. **Tushare Token**ï¼šç¡®ä¿Tushare Tokenæœ‰æ•ˆï¼Œé¿å…æ•°æ®è·å–å¤±è´¥ã€‚
3. **Redisè¿æ¥**ï¼šç¡®ä¿RedisæœåŠ¡ç¨³å®šè¿è¡Œã€‚
4. **ç›‘æ§Rediså­˜å‚¨ç©ºé—´**ï¼Œé¿å…æ•°æ®è¿‡å¤šã€‚
5. **å¤‡ä»½æ— æ•ˆè‚¡ç¥¨ä»£ç é…ç½®**ï¼Œå®šæœŸæ›´æ–°ã€‚
6. **å®æ—¶æ•°æ®æ¥å£ç›‘æ§**ï¼šæ–°æµªæ¥å£å¯èƒ½å¤±æ•ˆï¼Œéœ€è¦ç›‘æ§å¹¶å‡†å¤‡å¤‡ç”¨æ–¹æ¡ˆã€‚

---

## ğŸ†š æ–°æ—§ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ï¼ˆé‡æ„åï¼‰ |
|------|--------|-----------------|
| ä»£ç ç»„ç»‡ | æ‰€æœ‰é€»è¾‘æ··åœ¨ä¸€èµ· | DDDåˆ†å±‚ï¼ŒåŸå­èƒ½åŠ›ç‹¬ç«‹ |
| è‚¡ç¥¨ä»£ç æ£€æŸ¥ | æ¯å‘¨ä¸€08:00 | å¯åŠ¨æ—¶æ‰§è¡Œ |
| ETFå¤„ç† | å•ç‹¬å¤„ç† | ä½œä¸ºç‰¹æ®Šè‚¡ç¥¨ç»Ÿä¸€ç®¡ç† |
| æ— æ•ˆä»£ç è¿‡æ»¤ | æ—  | è‡ªåŠ¨è¿‡æ»¤åŒ—äº¤æ‰€åºŸå¼ƒä»£ç  |
| ä»»åŠ¡åˆ†ç±» | æ— æ˜ç¡®åˆ†ç±» | å¯åŠ¨ä»»åŠ¡ + è¿è¡Œæ—¶ä»»åŠ¡ |
| ä¿¡å·è®¡ç®—è§¦å‘ | å®šæ—¶æ‰§è¡Œ | å®æ—¶æ›´æ–°åè‡ªåŠ¨è§¦å‘ |
| å®æ—¶æ•°æ®è·å– | åˆ†æ•£åœ¨å¤šå¤„ | ç»Ÿä¸€æ•°æ®æœåŠ¡å°è£… |
| å†å²æ•°æ®è·å– | åˆ†æ•£åœ¨å¤šå¤„ | ç»Ÿä¸€æ•°æ®æœåŠ¡å°è£… |
| Redisé”®è§„åˆ™ | è‚¡ç¥¨å’ŒETFä¸ç»Ÿä¸€ | ç»Ÿä¸€ä½¿ç”¨stock_trendæ ¼å¼ |
| ä»£ç å¯ç»´æŠ¤æ€§ | è¾ƒå·® | ä¼˜ç§€ |
| æµ‹è¯•å‹å¥½æ€§ | è¾ƒå·® | ä¼˜ç§€ |

---

## ğŸ¯ æœ¬æ¬¡ä¼˜åŒ–é‡ç‚¹

### 1. ç»Ÿä¸€æ•°æ®æœåŠ¡ âœ…

- å°è£…äº†è‚¡ç¥¨å’ŒETFçš„å†å²æ•°æ®è·å–æ–¹æ³•
- å°è£…äº†è‚¡ç¥¨å’ŒETFçš„å®æ—¶æ•°æ®è·å–æ–¹æ³•
- å®ç°äº†å®æ—¶æ•°æ®æ›´æ–°åˆ°å†å²Kçº¿çš„é€»è¾‘

### 2. å®æ—¶æ›´æ–°æ–¹æ³•å®ç° âœ…

- `realtime_update_all_stocks()` æ–¹æ³•å·²å®Œæ•´å®ç°
- æ”¯æŒå½“æ—¥Kçº¿æ•°æ®çš„æ›´æ–°å’Œæ–°å¢
- è‡ªåŠ¨ä¿æŒæœ€è¿‘180å¤©çš„æ•°æ®

### 3. Redisé”®è§„åˆ™ç»Ÿä¸€ âœ…

- ETFå’Œè‚¡ç¥¨ä½¿ç”¨ç›¸åŒçš„ `stock_trend:{ts_code}` æ ¼å¼
- ç®€åŒ–äº†æ•°æ®å¤„ç†é€»è¾‘

### 4. æ¸…ç†æ—§ä»£ç  âœ…

- åˆ é™¤äº† `STOCK_INIT_MODE` é…ç½®ï¼ˆå·²åºŸå¼ƒï¼‰
- æ›´æ–°äº† `app/main.py` å¯åŠ¨é€»è¾‘
- æ¸…ç†äº† `scheduler/__init__.py` ä¸­çš„æ—§æ¥å£

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [HTTP_API_æ¸…å•.md](./HTTP_API_æ¸…å•.md) - æ¥å£æ–‡æ¡£
- [åŠŸèƒ½ä¼˜åŒ–å®Œæˆæ€»ç»“.md](./åŠŸèƒ½ä¼˜åŒ–å®Œæˆæ€»ç»“.md) - ä¼˜åŒ–æ€»ç»“
- [æœ¬æ–‡ä»¶ä¸èƒ½åˆ é™¤.md](./æœ¬æ–‡ä»¶ä¸èƒ½åˆ é™¤.md) - ç³»ç»Ÿè¯´æ˜

---

**é‡æ„å®Œæˆï¼ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼Œç»´æŠ¤æ›´å®¹æ˜“ï¼** ğŸ‰
