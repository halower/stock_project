# å®žæ—¶æ•°æ®æ›´æ–°æ—¶é—´ç­–ç•¥è¯´æ˜Ž

## ðŸ“… æ›´æ–°æ—¶é—´è§„åˆ™

### 1. è‡ªåŠ¨è°ƒåº¦æ›´æ–°ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

**é€‚ç”¨æ—¶é—´**ï¼šå·¥ä½œæ—¥ 9:30-15:30

```
âœ… å¯ä»¥æ›´æ–°çš„æ—¶é—´æ®µï¼š
- ä¸Šåˆï¼š09:30 - 11:30 ï¼ˆäº¤æ˜“æ—¶é—´ï¼‰
- ä¸‹åˆï¼š13:00 - 15:00 ï¼ˆäº¤æ˜“æ—¶é—´ï¼‰
- æ”¶ç›˜åŽï¼š15:00 - 15:30 ï¼ˆèŽ·å–æ”¶ç›˜æ•°æ®ï¼‰

âŒ ä¸æ›´æ–°çš„æ—¶é—´æ®µï¼š
- å‘¨æœ«ï¼ˆå‘¨å…­ã€å‘¨æ—¥ï¼‰
- å·¥ä½œæ—¥çš„éžäº¤æ˜“æ—¶é—´ï¼ˆ15:30ä¹‹åŽï¼Œæ¬¡æ—¥9:30ä¹‹å‰ï¼‰
```

**æ›´æ–°é¢‘çŽ‡**ï¼šæ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

### 2. æ‰‹åŠ¨è§¦å‘æ›´æ–°ï¼ˆAPIè°ƒç”¨ï¼‰

**é€‚ç”¨æ—¶é—´**ï¼šâŒ **ä»»ä½•æ—¶é—´éƒ½å¯ä»¥æ‰§è¡Œ**

```bash
# æ‰‹åŠ¨è§¦å‘å®žæ—¶æ›´æ–°ï¼ˆä¸å—æ—¶é—´é™åˆ¶ï¼‰
curl -X POST "http://your-server:8000/api/stocks/scheduler/trigger" \
  -H "Authorization: Bearer eXvM4zU8nP9qWt3dRfKgH7jBcA2yE5sZ" \
  -H "Content-Type: application/json" \
  -d '{"task_type": "update_realtime"}'

# æ‰‹åŠ¨è§¦å‘æ”¶ç›˜æ•°æ®æ›´æ–°
curl -X POST "http://your-server:8000/api/stocks/scheduler/trigger" \
  -H "Authorization: Bearer eXvM4zU8nP9qWt3dRfKgH7jBcA2yE5sZ" \
  -H "Content-Type: application/json" \
  -d '{"task_type": "update_realtime", "is_closing_update": true}'
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä»»ä½•æ—¶é—´éƒ½å¯ä»¥æ‰§è¡Œï¼ˆåŒ…æ‹¬æ™šä¸Šã€å‘¨æœ«ï¼‰
- âœ… ä¼ é€’äº† `force_update=True` å‚æ•°
- âœ… ä¸å— `is_trading_time()` é™åˆ¶

## ðŸ” ä»£ç å®žçŽ°

### is_trading_time() å‡½æ•°

```python
def is_trading_time() -> bool:
    """
    åˆ¤æ–­æ˜¯å¦ä¸ºå¯ä»¥èŽ·å–å®žæ—¶æ•°æ®çš„æ—¶é—´
    
    æ‰©å±•æ—¶é—´èŒƒå›´ï¼š
    - äº¤æ˜“æ—¶é—´: 9:30-11:30, 13:00-15:00
    - æ”¶ç›˜åŽ: 15:00-15:30 (å¯ä»¥èŽ·å–æ”¶ç›˜æ•°æ®)
    - è¿™æ ·ç¡®ä¿åœ¨15:00-15:20æœŸé—´ä¹Ÿèƒ½æ›´æ–°æ•°æ®
    """
    now = datetime.now()
    
    # å‘¨æœ«ä¸äº¤æ˜“
    if now.weekday() >= 5:
        return False
    
    current_time = now.time()
    
    # æ‰©å±•çš„äº¤æ˜“æ—¶é—´: 9:30-11:30, 13:00-15:30
    morning_start = time(9, 30)
    morning_end = time(11, 30)
    afternoon_start = time(13, 0)
    afternoon_end = time(15, 30)  # âœ… æ‰©å±•åˆ°15:30
    
    return ((morning_start <= current_time <= morning_end) or 
            (afternoon_start <= current_time <= afternoon_end))
```

### update_realtime_stock_data() å‡½æ•°

```python
def update_realtime_stock_data(force_update=False, is_closing_update=False, auto_calculate_signals=False):
    """æ›´æ–°å®žæ—¶è‚¡ç¥¨æ•°æ®
    
    Args:
        force_update: æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼Œå¿½ç•¥äº¤æ˜“æ—¶é—´æ£€æŸ¥
        is_closing_update: æ˜¯å¦ä¸ºæ”¶ç›˜åŽæ›´æ–°
        auto_calculate_signals: æ˜¯å¦è‡ªåŠ¨è®¡ç®—ä¹°å…¥ä¿¡å·
    
    æ—¶é—´ç­–ç•¥ï¼š
    - äº¤æ˜“æ—¶é—´å†…ï¼ˆ9:30-15:00ï¼‰ï¼šæ¯15-20åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡å®žæ—¶æ•°æ®
    - æ”¶ç›˜åŽï¼ˆ15:00-15:30ï¼‰ï¼šå¯ä»¥èŽ·å–æ”¶ç›˜æ•°æ®
    - æ‰‹åŠ¨è§¦å‘ï¼ˆforce_update=Trueï¼‰ï¼šä»»ä½•æ—¶é—´éƒ½å¯ä»¥æ‰§è¡Œ  âœ…
    """
    if not force_update and not is_trading_time():
        logger.info("éžäº¤æ˜“æ—¶é—´ï¼Œè·³è¿‡è‡ªåŠ¨å®žæ—¶æ•°æ®æ›´æ–°ï¼ˆå¯ä»¥é€šè¿‡force_update=Trueå¼ºåˆ¶æ‰§è¡Œï¼‰")
        return
    
    # ... æ›´æ–°é€»è¾‘
```

### APIè§¦å‘å®žçŽ°

```python
elif task_type == 'update_realtime':
    threading.Thread(
        target=lambda: update_realtime_stock_data(
            force_update=True,  # âœ… æ‰‹åŠ¨è§¦å‘æ—¶å¼ºåˆ¶æ›´æ–°
            is_closing_update=is_closing_update
        ), 
        daemon=True
    ).start()
```

## ðŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸äº¤æ˜“æ—¶é—´
**æ—¶é—´**ï¼šå·¥ä½œæ—¥ 9:30-15:00  
**æ–¹å¼**ï¼šè‡ªåŠ¨è°ƒåº¦  
**é¢‘çŽ‡**ï¼šæ¯15åˆ†é’Ÿ  
**ç”¨é€”**ï¼šèŽ·å–å®žæ—¶äº¤æ˜“æ•°æ®

### åœºæ™¯2ï¼šæ”¶ç›˜åŽèŽ·å–æ”¶ç›˜ä»·
**æ—¶é—´**ï¼šå·¥ä½œæ—¥ 15:00-15:30  
**æ–¹å¼**ï¼šè‡ªåŠ¨è°ƒåº¦  
**é¢‘çŽ‡**ï¼š15:05, 15:20ï¼ˆä¸¤æ¬¡ï¼‰  
**ç”¨é€”**ï¼šèŽ·å–å‡†ç¡®çš„æ”¶ç›˜ä»·å’Œæˆäº¤é‡

### åœºæ™¯3ï¼šæ™šä¸Šæ‰‹åŠ¨æ›´æ–°
**æ—¶é—´**ï¼šä»»ä½•æ—¶é—´ï¼ˆå¦‚æ™šä¸Š23:00ï¼‰  
**æ–¹å¼**ï¼šæ‰‹åŠ¨APIè§¦å‘  
**ç”¨é€”**ï¼š
- æµ‹è¯•ç³»ç»ŸåŠŸèƒ½
- è¡¥å……æ›´æ–°æ•°æ®
- åº”æ€¥æ•°æ®ä¿®å¤

### åœºæ™¯4ï¼šå‘¨æœ«æ‰‹åŠ¨æ›´æ–°
**æ—¶é—´**ï¼šå‘¨æœ«  
**æ–¹å¼**ï¼šæ‰‹åŠ¨APIè§¦å‘  
**ç”¨é€”**ï¼š
- ç³»ç»Ÿç»´æŠ¤æµ‹è¯•
- æ•°æ®éªŒè¯
- å¼€å‘è°ƒè¯•

## âš ï¸ é‡è¦è¯´æ˜Ž

### 1. ä¸ºä»€ä¹ˆéœ€è¦15:00-15:30çš„çª—å£ï¼Ÿ

```
15:00 æ”¶ç›˜ 
  â†“
15:05 ç¬¬ä¸€æ¬¡æ›´æ–° â†’ å¯èƒ½æ•°æ®è¿˜åœ¨æ±‡æ€»
  â†“
15:20 ç¬¬äºŒæ¬¡æ›´æ–° â†’ èŽ·å–æœ€ç»ˆæ”¶ç›˜æ•°æ® âœ…
  â†“
15:30 åœæ­¢è‡ªåŠ¨æ›´æ–°
```

**åŽŸå› **ï¼š
- äº¤æ˜“æ‰€15:00æ”¶ç›˜ï¼Œä½†æ•°æ®æ±‡æ€»éœ€è¦æ—¶é—´
- 15:05å¯èƒ½èŽ·å–ä¸åˆ°å®Œæ•´æ•°æ®
- 15:20åŸºæœ¬èƒ½èŽ·å–åˆ°å‡†ç¡®çš„æ”¶ç›˜ä»·
- æ‰€ä»¥å»¶é•¿åˆ°15:30ç¡®ä¿èƒ½èŽ·å–æ”¶ç›˜æ•°æ®

### 2. æ‰‹åŠ¨è§¦å‘ä¸ºä»€ä¹ˆä¸å—æ—¶é—´é™åˆ¶ï¼Ÿ

**ç­”æ¡ˆ**ï¼šä¼ é€’äº† `force_update=True` å‚æ•°

```python
# è‡ªåŠ¨è°ƒåº¦
update_realtime_stock_data()  # force_updateé»˜è®¤ä¸ºFalseï¼Œå—æ—¶é—´é™åˆ¶

# æ‰‹åŠ¨è§¦å‘  
update_realtime_stock_data(force_update=True)  # å¼ºåˆ¶æ›´æ–°ï¼Œä¸å—æ—¶é—´é™åˆ¶ âœ…
```

### 3. æ™šä¸Šæ‰‹åŠ¨æ›´æ–°èƒ½èŽ·å–åˆ°æ•°æ®å—ï¼Ÿ

**èƒ½ï¼** è™½ç„¶ä¸æ˜¯å®žæ—¶äº¤æ˜“æ•°æ®ï¼Œä½†èƒ½èŽ·å–åˆ°ï¼š
- âœ… å½“å¤©çš„æ”¶ç›˜ä»·
- âœ… æˆäº¤é‡å’Œæˆäº¤é¢
- âœ… æ¶¨è·Œå¹…ç­‰ä¿¡æ¯

æ•°æ®æ¥æºï¼ˆæ–°æµªæˆ–ä¸œè´¢ï¼‰ä¼šç¼“å­˜å½“å¤©çš„äº¤æ˜“æ•°æ®ï¼Œæ‰€ä»¥æ™šä¸Šä¹Ÿèƒ½èŽ·å–ã€‚

## ðŸ“Š æ—¶é—´çº¿ç¤ºä¾‹

### å·¥ä½œæ—¥å®Œæ•´æ—¶é—´çº¿

```
00:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” éžäº¤æ˜“æ—¶é—´ï¼ˆè‡ªåŠ¨è°ƒåº¦ä¸æ‰§è¡Œï¼‰
      â¬† å¯æ‰‹åŠ¨è§¦å‘ï¼ˆèŽ·å–æ˜¨æ—¥æ•°æ®ï¼‰
09:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” éžäº¤æ˜“æ—¶é—´
09:30 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” äº¤æ˜“å¼€å§‹ âœ…
09:45 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬1æ¬¡ï¼‰
10:00 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬2æ¬¡ï¼‰
10:15 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬3æ¬¡ï¼‰
10:30 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬4æ¬¡ï¼‰
10:45 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬5æ¬¡ï¼‰
11:00 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬6æ¬¡ï¼‰
11:15 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬7æ¬¡ï¼‰
11:30 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” åˆä¼‘
13:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” äº¤æ˜“ç»§ç»­ âœ…
13:15 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬8æ¬¡ï¼‰
13:30 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬9æ¬¡ï¼‰
13:45 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬10æ¬¡ï¼‰
14:00 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬11æ¬¡ï¼‰
14:15 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬12æ¬¡ï¼‰
14:30 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬13æ¬¡ï¼‰
14:45 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬14æ¬¡ï¼‰
15:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” æ”¶ç›˜ ðŸ“Š
15:05 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬15æ¬¡ï¼Œæ”¶ç›˜æ•°æ®ç¬¬ä¸€æ¬¡ï¼‰
15:20 âš¡ è‡ªåŠ¨æ›´æ–°ï¼ˆç¬¬16æ¬¡ï¼Œæ”¶ç›˜æ•°æ®ç¬¬äºŒæ¬¡ï¼‰âœ…
15:30 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” åœæ­¢è‡ªåŠ¨æ›´æ–°
      â¬† ä¹‹åŽéœ€è¦æ‰‹åŠ¨è§¦å‘
23:00 ðŸ”§ å¯æ‰‹åŠ¨è§¦å‘ï¼ˆèŽ·å–ä»Šæ—¥æ”¶ç›˜æ•°æ®ï¼‰
```

## ðŸ› ï¸ é…ç½®å»ºè®®

### Docker Compose é…ç½®

```yaml
environment:
  # å®žæ—¶è¡Œæƒ…é…ç½®
  - REALTIME_DATA_PROVIDER=auto          # è‡ªåŠ¨é€‰æ‹©æ•°æ®æº
  - REALTIME_UPDATE_INTERVAL=15          # 15åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
  - REALTIME_AUTO_SWITCH=true            # å¯ç”¨è‡ªåŠ¨åˆ‡æ¢
```

### è°ƒåº¦å™¨é…ç½®

è°ƒåº¦å™¨ä¼šè‡ªåŠ¨æŒ‰ç…§ä»¥ä¸‹è§„åˆ™æ‰§è¡Œï¼š

```python
# äº¤æ˜“æ—¶é—´å†…æ¯15åˆ†é’Ÿæ›´æ–°
scheduler.add_job(
    update_realtime_stock_data,
    trigger=IntervalTrigger(minutes=15),
    id='update_realtime',
    # ... ä»…åœ¨ is_trading_time() è¿”å›ž True æ—¶æ‰§è¡Œ
)
```

## âœ… æ€»ç»“

| è§¦å‘æ–¹å¼ | æ—¶é—´é™åˆ¶ | force_update | ä½¿ç”¨åœºæ™¯ |
|---------|---------|--------------|----------|
| **è‡ªåŠ¨è°ƒåº¦** | âœ… 9:30-15:30 | False | æ­£å¸¸äº¤æ˜“æ—¶é—´è‡ªåŠ¨æ›´æ–° |
| **APIè§¦å‘** | âŒ æ— é™åˆ¶ | True | ä»»ä½•æ—¶é—´æ‰‹åŠ¨æ›´æ–° |

**å…³é”®ç‚¹**ï¼š
1. âœ… è‡ªåŠ¨è°ƒåº¦å·²æ‰©å±•åˆ°15:30ï¼Œè¦†ç›–æ”¶ç›˜æ•°æ®èŽ·å–çª—å£
2. âœ… æ‰‹åŠ¨è§¦å‘ä¸å—ä»»ä½•æ—¶é—´é™åˆ¶ï¼Œéšæ—¶å¯ç”¨
3. âœ… 15:00-15:30çª—å£ç¡®ä¿èƒ½èŽ·å–å‡†ç¡®çš„æ”¶ç›˜ä»·
4. âœ… æ™šä¸Šå’Œå‘¨æœ«ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘èŽ·å–æ•°æ®

---

**ç‰ˆæœ¬**: v1.1.0  
**æ›´æ–°æ—¶é—´**: 2025-10-21  
**æ”¹è¿›ç‚¹**: æ‰©å±•è‡ªåŠ¨æ›´æ–°çª—å£åˆ°15:30ï¼Œç¡®ä¿æ”¶ç›˜æ•°æ®å‡†ç¡®æ€§

