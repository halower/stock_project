# 实时数据更新时间策略说明

## 📅 更新时间规则

### 1. 自动调度更新（定时任务）

**适用时间**：工作日 9:30-15:30

```
✅ 可以更新的时间段：
- 上午：09:30 - 11:30 （交易时间）
- 下午：13:00 - 15:00 （交易时间）
- 收盘后：15:00 - 15:30 （获取收盘数据）

❌ 不更新的时间段：
- 周末（周六、周日）
- 工作日的非交易时间（15:30之后，次日9:30之前）
```

**更新频率**：每15分钟执行一次

### 2. 手动触发更新（API调用）

**适用时间**：❌ **任何时间都可以执行**

```bash
# 手动触发实时更新（不受时间限制）
curl -X POST "http://your-server:8000/api/stocks/scheduler/trigger" \
  -H "Authorization: Bearer eXvM4zU8nP9qWt3dRfKgH7jBcA2yE5sZ" \
  -H "Content-Type: application/json" \
  -d '{"task_type": "update_realtime"}'

# 手动触发收盘数据更新
curl -X POST "http://your-server:8000/api/stocks/scheduler/trigger" \
  -H "Authorization: Bearer eXvM4zU8nP9qWt3dRfKgH7jBcA2yE5sZ" \
  -H "Content-Type: application/json" \
  -d '{"task_type": "update_realtime", "is_closing_update": true}'
```

**特点**：
- ✅ 任何时间都可以执行（包括晚上、周末）
- ✅ 传递了 `force_update=True` 参数
- ✅ 不受 `is_trading_time()` 限制

## 🔍 代码实现

### is_trading_time() 函数

```python
def is_trading_time() -> bool:
    """
    判断是否为可以获取实时数据的时间
    
    扩展时间范围：
    - 交易时间: 9:30-11:30, 13:00-15:00
    - 收盘后: 15:00-15:30 (可以获取收盘数据)
    - 这样确保在15:00-15:20期间也能更新数据
    """
    now = datetime.now()
    
    # 周末不交易
    if now.weekday() >= 5:
        return False
    
    current_time = now.time()
    
    # 扩展的交易时间: 9:30-11:30, 13:00-15:30
    morning_start = time(9, 30)
    morning_end = time(11, 30)
    afternoon_start = time(13, 0)
    afternoon_end = time(15, 30)  # ✅ 扩展到15:30
    
    return ((morning_start <= current_time <= morning_end) or 
            (afternoon_start <= current_time <= afternoon_end))
```

### update_realtime_stock_data() 函数

```python
def update_realtime_stock_data(force_update=False, is_closing_update=False, auto_calculate_signals=False):
    """更新实时股票数据
    
    Args:
        force_update: 是否强制更新，忽略交易时间检查
        is_closing_update: 是否为收盘后更新
        auto_calculate_signals: 是否自动计算买入信号
    
    时间策略：
    - 交易时间内（9:30-15:00）：每15-20分钟更新一次实时数据
    - 收盘后（15:00-15:30）：可以获取收盘数据
    - 手动触发（force_update=True）：任何时间都可以执行  ✅
    """
    if not force_update and not is_trading_time():
        logger.info("非交易时间，跳过自动实时数据更新（可以通过force_update=True强制执行）")
        return
    
    # ... 更新逻辑
```

### API触发实现

```python
elif task_type == 'update_realtime':
    threading.Thread(
        target=lambda: update_realtime_stock_data(
            force_update=True,  # ✅ 手动触发时强制更新
            is_closing_update=is_closing_update
        ), 
        daemon=True
    ).start()
```

## 💡 使用场景

### 场景1：正常交易时间
**时间**：工作日 9:30-15:00  
**方式**：自动调度  
**频率**：每15分钟  
**用途**：获取实时交易数据

### 场景2：收盘后获取收盘价
**时间**：工作日 15:00-15:30  
**方式**：自动调度  
**频率**：15:05, 15:20（两次）  
**用途**：获取准确的收盘价和成交量

### 场景3：晚上手动更新
**时间**：任何时间（如晚上23:00）  
**方式**：手动API触发  
**用途**：
- 测试系统功能
- 补充更新数据
- 应急数据修复

### 场景4：周末手动更新
**时间**：周末  
**方式**：手动API触发  
**用途**：
- 系统维护测试
- 数据验证
- 开发调试

## ⚠️ 重要说明

### 1. 为什么需要15:00-15:30的窗口？

```
15:00 收盘 
  ↓
15:05 第一次更新 → 可能数据还在汇总
  ↓
15:20 第二次更新 → 获取最终收盘数据 ✅
  ↓
15:30 停止自动更新
```

**原因**：
- 交易所15:00收盘，但数据汇总需要时间
- 15:05可能获取不到完整数据
- 15:20基本能获取到准确的收盘价
- 所以延长到15:30确保能获取收盘数据

### 2. 手动触发为什么不受时间限制？

**答案**：传递了 `force_update=True` 参数

```python
# 自动调度
update_realtime_stock_data()  # force_update默认为False，受时间限制

# 手动触发  
update_realtime_stock_data(force_update=True)  # 强制更新，不受时间限制 ✅
```

### 3. 晚上手动更新能获取到数据吗？

**能！** 虽然不是实时交易数据，但能获取到：
- ✅ 当天的收盘价
- ✅ 成交量和成交额
- ✅ 涨跌幅等信息

数据来源（新浪或东财）会缓存当天的交易数据，所以晚上也能获取。

## 📊 时间线示例

### 工作日完整时间线

```
00:00 ━━━━━━━━━━━━━━━━━━━━━━━ 非交易时间（自动调度不执行）
      ⬆ 可手动触发（获取昨日数据）
09:00 ━━━━━━━━━━━━━━━━━━━━━━━ 非交易时间
09:30 ━━━━━━━━━━━━━━━━━━━━━━━ 交易开始 ✅
09:45 ⚡ 自动更新（第1次）
10:00 ⚡ 自动更新（第2次）
10:15 ⚡ 自动更新（第3次）
10:30 ⚡ 自动更新（第4次）
10:45 ⚡ 自动更新（第5次）
11:00 ⚡ 自动更新（第6次）
11:15 ⚡ 自动更新（第7次）
11:30 ━━━━━━━━━━━━━━━━━━━━━━━ 午休
13:00 ━━━━━━━━━━━━━━━━━━━━━━━ 交易继续 ✅
13:15 ⚡ 自动更新（第8次）
13:30 ⚡ 自动更新（第9次）
13:45 ⚡ 自动更新（第10次）
14:00 ⚡ 自动更新（第11次）
14:15 ⚡ 自动更新（第12次）
14:30 ⚡ 自动更新（第13次）
14:45 ⚡ 自动更新（第14次）
15:00 ━━━━━━━━━━━━━━━━━━━━━━━ 收盘 📊
15:05 ⚡ 自动更新（第15次，收盘数据第一次）
15:20 ⚡ 自动更新（第16次，收盘数据第二次）✅
15:30 ━━━━━━━━━━━━━━━━━━━━━━━ 停止自动更新
      ⬆ 之后需要手动触发
23:00 🔧 可手动触发（获取今日收盘数据）
```

## 🛠️ 配置建议

### Docker Compose 配置

```yaml
environment:
  # 实时行情配置
  - REALTIME_DATA_PROVIDER=auto          # 自动选择数据源
  - REALTIME_UPDATE_INTERVAL=15          # 15分钟更新一次
  - REALTIME_AUTO_SWITCH=true            # 启用自动切换
```

### 调度器配置

调度器会自动按照以下规则执行：

```python
# 交易时间内每15分钟更新
scheduler.add_job(
    update_realtime_stock_data,
    trigger=IntervalTrigger(minutes=15),
    id='update_realtime',
    # ... 仅在 is_trading_time() 返回 True 时执行
)
```

## ✅ 总结

| 触发方式 | 时间限制 | force_update | 使用场景 |
|---------|---------|--------------|----------|
| **自动调度** | ✅ 9:30-15:30 | False | 正常交易时间自动更新 |
| **API触发** | ❌ 无限制 | True | 任何时间手动更新 |

**关键点**：
1. ✅ 自动调度已扩展到15:30，覆盖收盘数据获取窗口
2. ✅ 手动触发不受任何时间限制，随时可用
3. ✅ 15:00-15:30窗口确保能获取准确的收盘价
4. ✅ 晚上和周末也可以手动触发获取数据

---

**版本**: v1.1.0  
**更新时间**: 2025-10-21  
**改进点**: 扩展自动更新窗口到15:30，确保收盘数据准确性

