# 股票数据服务启动说明

> 更新时间：2025-11-08
> 版本：DDD重构版

## 📋 启动方式

### 1. Docker Compose 启动（推荐）

#### 首次部署（全量初始化）

```bash
# 修改 docker-compose.yml 中的环境变量
SCHEDULER_INIT_MODE=full_init
SCHEDULER_CALCULATE_SIGNALS=true

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f api
```

#### 日常启动（快速启动）

```bash
# 使用默认配置（skip模式）
docker-compose up -d

# 查看日志
docker-compose logs -f api
```

#### 停止服务

```bash
docker-compose down
```

#### 重启服务

```bash
docker-compose restart api
```

---

### 2. 本地开发启动

#### 安装依赖

```bash
pip install -r requirements.txt
```

#### 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，修改相应配置
vim .env
```

#### 启动Redis

```bash
# 使用Docker启动Redis
docker run -d -p 6379:6379 --name stock_redis redis:latest

# 或使用本地Redis
redis-server
```

#### 启动应用

```bash
# 首次部署（全量初始化）
export SCHEDULER_INIT_MODE=full_init
export SCHEDULER_CALCULATE_SIGNALS=true
python run.py

# 日常启动（快速启动）
export SCHEDULER_INIT_MODE=skip
export SCHEDULER_CALCULATE_SIGNALS=false
python run.py

# 或使用uvicorn直接启动
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

---

## ⚙️ 启动配置说明

### 环境变量配置

| 环境变量 | 说明 | 可选值 | 默认值 |
|---------|------|--------|--------|
| `SCHEDULER_INIT_MODE` | 初始化模式 | `skip`, `full_init` | `skip` |
| `SCHEDULER_CALCULATE_SIGNALS` | 启动时计算信号 | `true`, `false` | `false` |
| `TUSHARE_TOKEN` | Tushare Token | 字符串 | 必填 |
| `REDIS_HOST` | Redis主机 | 字符串 | `localhost` |
| `REDIS_PORT` | Redis端口 | 数字 | `6379` |

### 初始化模式详解

#### `skip` - 跳过初始化（推荐日常使用）

**特点**：
- ✅ 快速启动（3-5秒）
- ✅ 不重新获取数据
- ✅ 依赖定时任务更新数据
- ✅ 适合日常重启

**执行流程**：
1. 获取有效股票代码列表
2. 爬取最新新闻
3. 启动定时任务

**适用场景**：
- 日常重启服务
- 数据已存在
- 快速恢复服务

#### `full_init` - 全量初始化

**特点**：
- ⚠️ 启动较慢（10-30分钟，取决于股票数量）
- ✅ 清空并重新获取所有数据
- ✅ 确保数据完整性
- ✅ 适合首次部署或数据修复

**执行流程**：
1. 获取有效股票代码列表
2. 清空所有K线数据
3. 重新获取90个交易日的历史数据
4. 爬取最新新闻
5. （可选）计算所有买入信号
6. 启动定时任务

**适用场景**：
- 首次部署
- Redis数据丢失
- 数据损坏需要修复
- 需要重新初始化所有数据

---

## 🚀 启动场景示例

### 场景1：首次部署

```bash
# Docker Compose
# 修改 docker-compose.yml
SCHEDULER_INIT_MODE=full_init
SCHEDULER_CALCULATE_SIGNALS=true

docker-compose up -d
```

**预期**：
- 启动时间：10-30分钟
- 获取所有股票和ETF的历史数据
- 计算所有买入信号
- 启动定时任务

---

### 场景2：日常重启

```bash
# Docker Compose（使用默认配置）
docker-compose restart api
```

**预期**：
- 启动时间：3-5秒
- 跳过数据初始化
- 依赖定时任务更新数据

---

### 场景3：数据修复

```bash
# Docker Compose
# 临时修改环境变量
docker-compose down
# 修改 docker-compose.yml
SCHEDULER_INIT_MODE=full_init
SCHEDULER_CALCULATE_SIGNALS=true

docker-compose up -d

# 修复完成后，改回默认配置
docker-compose down
# 修改 docker-compose.yml
SCHEDULER_INIT_MODE=skip
SCHEDULER_CALCULATE_SIGNALS=false

docker-compose up -d
```

---

### 场景4：本地开发

```bash
# 快速启动（使用默认配置）
python run.py

# 或使用uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

---

## 📊 定时任务说明

启动后，系统会自动运行以下定时任务：

| 任务名称 | 执行时间 | 说明 |
|---------|---------|------|
| 实时数据更新 | 每20分钟 | 获取所有股票和ETF的最新价格 |
| 新闻爬取 | 每2小时 | 爬取最新的财经新闻 |
| 全量更新并计算信号 | 每个交易日17:35 | 清空并重新获取历史数据，计算买入信号 |
| 图表文件清理 | 每天00:00 | 清理旧的图表文件 |

---

## 🔍 启动日志说明

### 正常启动日志

```
Stock Intelligence API 服务启动...
任务调度器启动成功
后台初始化开始...
Redis连接成功
新闻调度器启动成功
股票调度器启动中...
========== 启动股票调度器 ==========
初始化模式: skip
启动时计算信号: False
步骤1: 获取有效股票代码列表...
获取到 5000 只有效股票/ETF代码
步骤2: 跳过K线数据初始化...
步骤3: 启动时爬取最新新闻...
========== 股票调度器启动完成 ==========
后台初始化完成
API服务已启动 - 文档地址: /docs
```

### 全量初始化日志

```
========== 启动股票调度器 ==========
初始化模式: full_init
启动时计算信号: True
步骤1: 获取有效股票代码列表...
获取到 5000 只有效股票/ETF代码
步骤2: 执行全量初始化 (清空并重新获取K线数据)...
开始全量更新所有股票数据...
成功更新 5000 只股票/ETF
步骤3: 启动时爬取最新新闻...
步骤4: 启动时计算买入信号...
开始计算所有股票信号...
========== 股票调度器启动完成 ==========
```

---

## ⚠️ 常见问题

### 1. 启动很慢

**原因**：使用了 `full_init` 模式

**解决**：
- 首次部署必须使用 `full_init`
- 日常使用改为 `skip` 模式

### 2. Redis连接失败

**原因**：Redis服务未启动或配置错误

**解决**：
```bash
# 检查Redis是否运行
docker ps | grep redis

# 启动Redis
docker-compose up -d redis

# 检查Redis连接
redis-cli ping
```

### 3. Tushare Token错误

**原因**：Token未配置或无效

**解决**：
- 在 `docker-compose.yml` 或 `.env` 中配置正确的Token
- 访问 https://tushare.pro/ 获取Token

### 4. 数据不更新

**原因**：定时任务未启动或执行失败

**解决**：
```bash
# 查看调度器状态
curl http://localhost:8000/api/stocks/scheduler/status

# 查看日志
docker-compose logs -f api | grep "调度器"
```

---

## 📞 相关文档

- [任务计划清单.md](./任务计划清单.md) - 详细的任务计划
- [功能优化完成总结.md](./功能优化完成总结.md) - 优化总结
- [HTTP_API_清单.md](./HTTP_API_清单.md) - API接口文档

---

**启动配置已完成！默认使用skip模式快速启动！** 🚀

