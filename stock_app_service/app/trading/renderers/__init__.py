# -*- coding: utf-8 -*-
"""å›¾è¡¨ç»˜åˆ¶æ¨¡å—"""

import pandas as pd
from typing import Dict, Type, Optional, List, Any

from app.core.logging import logger
from app.trading.renderers.base_chart_strategy import BaseChartStrategy
from app.trading.renderers.volume_wave_chart_strategy import VolumeWaveChartStrategy
from app.trading.renderers.volume_wave_enhanced_chart_strategy import VolumeWaveEnhancedChartStrategy
from app.trading.renderers.volatility_conservation_chart_strategy import VolatilityConservationChartStrategy

# æ³¨å†Œæ‰€æœ‰å¯ç”¨çš„å›¾è¡¨ç­–ç•¥ï¼ˆæ‰‹åŠ¨æ³¨å†Œï¼Œä¿æŒå‘åå…¼å®¹ï¼‰
REGISTERED_CHART_STRATEGIES: Dict[str, Type[BaseChartStrategy]] = {
    VolumeWaveChartStrategy.STRATEGY_CODE: VolumeWaveChartStrategy,
    VolumeWaveEnhancedChartStrategy.STRATEGY_CODE: VolumeWaveEnhancedChartStrategy,
    'volatility_conservation': VolatilityConservationChartStrategy
}


def _generate_default_chart_strategy(strategy_code: str, strategy_class) -> Type[BaseChartStrategy]:
    """
    ä¸ºç­–ç•¥ç”Ÿæˆé»˜è®¤çš„å›¾è¡¨ç­–ç•¥ç±»
    
    é€‚ç”¨äºä½¿ç”¨@register_strategyè£…é¥°å™¨æ³¨å†Œçš„ç­–ç•¥ï¼Œä½†æ²¡æœ‰ä¸“ç”¨å›¾è¡¨ç­–ç•¥ç±»çš„æƒ…å†µ
    
    Args:
        strategy_code: ç­–ç•¥ä»£ç 
        strategy_class: ç­–ç•¥ç±»
        
    Returns:
        åŠ¨æ€ç”Ÿæˆçš„å›¾è¡¨ç­–ç•¥ç±»
    """
    # è·å–ç­–ç•¥çš„å›¾è¡¨é…ç½®
    chart_series = getattr(strategy_class, 'CHART_SERIES', {})
    strategy_name = getattr(strategy_class, 'STRATEGY_NAME', strategy_code)
    strategy_desc = getattr(strategy_class, 'STRATEGY_DESCRIPTION', '')
    
    class AutoGeneratedChartStrategy(BaseChartStrategy):
        """è‡ªåŠ¨ç”Ÿæˆçš„å›¾è¡¨ç­–ç•¥ç±»"""
        STRATEGY_CODE = strategy_code
        STRATEGY_NAME = strategy_name
        STRATEGY_DESCRIPTION = strategy_desc
        
        @classmethod
        def generate_chart_html(cls, stock_data: Dict[str, Any], **kwargs) -> str:
            """ä½¿ç”¨åŸºç±»çš„é€šç”¨æ¸²æŸ“é€»è¾‘"""
            try:
                stock = stock_data['stock']
                df = stock_data['data']
                signals = stock_data.get('signals', [])
                theme = kwargs.get('theme', 'dark')
                
                chart_data = cls._prepare_chart_data(df)
                volume_data = cls._prepare_volume_data(chart_data)
                markers = cls._prepare_markers(df, signals)
                colors = cls.get_theme_colors(theme)
                
                # å‡†å¤‡é¢å¤–çš„ç³»åˆ—ï¼ˆåŸºäºCHART_SERIESé…ç½®ï¼‰
                additional_series = ""
                if chart_series:
                    for series_id, series_config in chart_series.items():
                        series_type = series_config.get('type', 'line')
                        data_column = series_config.get('data_column', series_id)
                        
                        if series_type == 'line' and data_column in df.columns:
                            series_data = cls._prepare_ema_data(df, data_column)
                            color = series_config.get('color', '#888888')
                            additional_series += f"""
                            const {series_id}Series = chart.addLineSeries({{
                                color: '{color}',
                                lineWidth: 2,
                                title: '',
                                priceLineVisible: false,
                                lastValueVisible: false,
                            }});
                            {series_id}Series.setData({series_data});
                            """
                
                # è®¡ç®—æŒ‡æ ‡æ•°æ®ï¼ˆé€šç”¨æŒ‡æ ‡ï¼‰
                from app.trading.indicators.tradingview.volume_profile_pivot_anchored import calculate_volume_profile_pivot_anchored
                from app.trading.indicators.tradingview.pivot_order_blocks import calculate_pivot_order_blocks
                from app.trading.indicators.tradingview.divergence_detector import calculate_divergence_detector
                
                volume_profile = calculate_volume_profile_pivot_anchored(
                    df, pivot_length=20, profile_levels=25, value_area_percent=68.0, profile_width=0.30
                )
                
                pivot_order_blocks = calculate_pivot_order_blocks(
                    df, left=15, right=8, box_count=2, percentage_change=6.0, box_extend_to_end=True
                )
                pivot_order_blocks_for_pool = []
                if pivot_order_blocks:
                    for block in pivot_order_blocks:
                        pivot_order_blocks_for_pool.append({
                            'type': 'resistance' if block['type'] == 'resistance' else 'support',
                            'price_high': block['price_high'],
                            'price_low': block['price_low'],
                            'start_time': cls._get_time_string(df, block['start_index']),
                            'end_time': cls._get_time_string(df, block['end_index']),
                            'strength': block.get('strength', 0.8)
                        })
                
                divergence_data = calculate_divergence_detector(
                    df, pivot_period=5, max_pivot_points=10, max_bars=100,
                    check_macd=True, check_rsi=True, check_stoch=True, check_cci=True, check_momentum=True
                )
                
                # å‡†å¤‡EMAæ•°æ®
                ema6_data = cls._prepare_ema_data(df, 'ema6') if 'ema6' in df.columns else []
                ema12_data = cls._prepare_ema_data(df, 'ema12') if 'ema12' in df.columns else []
                ema18_data = cls._prepare_ema_data(df, 'ema18') if 'ema18' in df.columns else []
                ema144_data = cls._prepare_ema_data(df, 'ema144') if 'ema144' in df.columns else []
                ema169_data = cls._prepare_ema_data(df, 'ema169') if 'ema169' in df.columns else []
                
                # ç”ŸæˆæŒ‡æ ‡æ± è„šæœ¬
                indicator_pool_scripts = cls._generate_indicator_pool_scripts(
                    ema6_data, ema12_data, ema18_data, ema144_data, ema169_data,
                    volume_profile, pivot_order_blocks_for_pool, divergence_data, None
                )
                
                additional_scripts = additional_series + indicator_pool_scripts
                
                return cls._generate_base_html_template(
                    stock=stock,
                    strategy_name=cls.STRATEGY_NAME,
                    strategy_desc=cls.STRATEGY_DESCRIPTION,
                    chart_data=chart_data,
                    markers=markers,
                    volume_data=volume_data,
                    additional_series="",
                    additional_scripts=additional_scripts,
                    colors=colors
                )
            except Exception as e:
                logger.error(f"ç”Ÿæˆè‡ªåŠ¨å›¾è¡¨å¤±è´¥: {str(e)}")
                import traceback
                logger.error(f"å®Œæ•´é”™è¯¯å †æ ˆ:\n{traceback.format_exc()}")
                raise
        
        @classmethod
        def _prepare_ema_data(cls, df, ema_column: str):
            """å‡†å¤‡EMAæ•°æ®"""
            if ema_column not in df.columns:
                return []
            data = []
            for idx, row in df.iterrows():
                time_val = cls._get_time_string(df, idx if isinstance(idx, int) else df.index.get_loc(idx))
                ema_val = row.get(ema_column)
                if time_val and ema_val is not None and not pd.isna(ema_val):
                    data.append({'time': time_val, 'value': float(ema_val)})
            return data
        
        @classmethod
        def _get_time_string(cls, df, idx: int) -> str:
            """è·å–æ—¶é—´å­—ç¬¦ä¸²"""
            import pandas as pd
            if 'date' in df.columns:
                date_val = df.iloc[idx]['date']
                if isinstance(date_val, str):
                    return date_val[:10]
                elif isinstance(date_val, pd.Timestamp):
                    return date_val.strftime('%Y-%m-%d')
            return str(idx)
    
    return AutoGeneratedChartStrategy


def _auto_generate_chart_strategies():
    """
    ä¸ºæ‰€æœ‰å·²æ³¨å†Œçš„ç­–ç•¥è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ç­–ç•¥ï¼ˆå¦‚æœå°šæœªæœ‰ä¸“ç”¨å›¾è¡¨ç­–ç•¥ï¼‰
    """
    # å»¶è¿Ÿå¯¼å…¥ï¼Œé¿å…å¾ªç¯ä¾èµ–
    from app.trading.strategies import REGISTERED_STRATEGIES
    
    for strategy_code, strategy_class in REGISTERED_STRATEGIES.items():
        # å¦‚æœç­–ç•¥å·²æœ‰ä¸“ç”¨å›¾è¡¨ç­–ç•¥ï¼Œè·³è¿‡
        if strategy_code in REGISTERED_CHART_STRATEGIES:
            continue
        
        # ä¸ºç­–ç•¥ç”Ÿæˆé»˜è®¤å›¾è¡¨ç­–ç•¥
        chart_strategy_class = _generate_default_chart_strategy(strategy_code, strategy_class)
        REGISTERED_CHART_STRATEGIES[strategy_code] = chart_strategy_class
        logger.info(f"ğŸ“Š å·²è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ç­–ç•¥: {strategy_code} ({chart_strategy_class.STRATEGY_NAME})")


# è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ç­–ç•¥ï¼ˆæ‰‹åŠ¨æ³¨å†Œçš„ä¼˜å…ˆçº§æ›´é«˜ï¼‰
_auto_generate_chart_strategies()


def get_chart_strategy_by_code(strategy_code: str) -> Optional[Type[BaseChartStrategy]]:
    """
    æ ¹æ®ç­–ç•¥ä»£ç è·å–å›¾è¡¨ç­–ç•¥ç±»
    
    Args:
        strategy_code: ç­–ç•¥å”¯ä¸€æ ‡è¯†ä»£ç 
        
    Returns:
        å¯¹åº”çš„å›¾è¡¨ç­–ç•¥ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›None
    """
    return REGISTERED_CHART_STRATEGIES.get(strategy_code)

def get_all_chart_strategies() -> Dict[str, Dict[str, str]]:
    """
    è·å–æ‰€æœ‰æ³¨å†Œçš„å›¾è¡¨ç­–ç•¥ä¿¡æ¯
    
    Returns:
        åŒ…å«æ‰€æœ‰å›¾è¡¨ç­–ç•¥ä¿¡æ¯çš„å­—å…¸ï¼Œé”®ä¸ºç­–ç•¥ä»£ç ï¼Œå€¼ä¸ºåŒ…å«åç§°å’Œæè¿°çš„å­—å…¸
    """
    return {
        code: {
            "code": code,
            "name": strat.get_strategy_name(),
            "description": strat.get_strategy_description()
        }
        for code, strat in REGISTERED_CHART_STRATEGIES.items()
    }

def generate_chart_html(strategy_code: str, stock_data: Dict[str, Any], **kwargs) -> str:
    """
    ä½¿ç”¨æŒ‡å®šç­–ç•¥ç”Ÿæˆå›¾è¡¨HTML
    
    Args:
        strategy_code: ç­–ç•¥ä»£ç 
        stock_data: è‚¡ç¥¨æ•°æ®å­—å…¸ï¼ŒåŒ…å«stockã€dataã€signalsç­‰ä¿¡æ¯
        **kwargs: ç­–ç•¥ç‰¹å®šçš„å‚æ•°
        
    Returns:
        ç”Ÿæˆçš„HTMLå­—ç¬¦ä¸²ï¼Œå¦‚æœç­–ç•¥ä¸å­˜åœ¨åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
    """
    strategy_class = get_chart_strategy_by_code(strategy_code)
    
    if strategy_class:
        return strategy_class.generate_chart_html(stock_data, **kwargs)
    
    # ç­–ç•¥ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    return "" 